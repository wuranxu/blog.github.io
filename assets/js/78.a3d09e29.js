(window.webpackJsonp=window.webpackJsonp||[]).push([[78],{479:function(e,t,s){"use strict";s.r(t);var _=s(2),v=Object(_.a)({},(function(){var e=this,t=e._self._c;return t("ContentSlotsDistributor",{attrs:{"slot-key":e.$parent.slotKey}},[t("blockquote",[t("p",[e._v("大家好~我是"),t("code",[e._v("米洛")]),e._v("！"),t("br"),e._v("\n我正在从0到1打造一个开源的接口测试平台, 也在编写一套与之对应的"),t("code",[e._v("教程")]),e._v("，希望大家多多支持。"),t("br"),e._v("\n欢迎关注我的公众号"),t("code",[e._v("米洛的测开日记")]),e._v("，一起交流学习!")])]),e._v(" "),t("h3",{attrs:{id:"回顾"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#回顾"}},[e._v("#")]),e._v(" 回顾")]),e._v(" "),t("p",[e._v("上一节我们"),t("code",[e._v("review")]),e._v("了一下代码，这一节我们来进入正轨，聊聊sqlalchemy彻底"),t("code",[e._v("异步化")]),e._v("。")]),e._v(" "),t("h3",{attrs:{id:"历史问题"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#历史问题"}},[e._v("#")]),e._v(" 历史问题")]),e._v(" "),t("p",[e._v("由于"),t("code",[e._v("pity")]),e._v("支持了在线编写/执行sql语句的功能，所以为了更加友好，我们特意提供了读取数据库表/字段的功能，看看下图:")]),e._v(" "),t("p",[t("img",{attrs:{src:"https://files.mdnice.com/user/11504/537f864f-5864-4e0a-8b71-ac24e6b90075.png",alt:""}})]),e._v(" "),t("p",[e._v("这样做的目的，并不是"),t("code",[e._v("炫技")]),e._v("，而是给大家一个更舒适的编写sql的环境，如果写sql的时候，数据库表和字段都给你"),t("code",[e._v("联想")]),e._v("了，那写起来就更轻松了。")]),e._v(" "),t("p",[e._v("但这么个功能呢~却不是那么好做，因为据我所知，这个功能需要用到Metadata，接着利用其的反射方法，获取到对应的"),t("code",[e._v("表")]),e._v("和"),t("code",[e._v("字段")]),e._v("信息。而异步engine又无法获取metadata相关数据，包括"),t("code",[e._v("自动建表")]),e._v("。")]),e._v(" "),t("p",[e._v("为此我一直保持着"),t("code",[e._v("同步session")]),e._v("和"),t("code",[e._v("异步session")]),e._v("混用的状态，当然这肯定不是很好的方案。")]),e._v(" "),t("p",[e._v("于是我今天突发奇想，还真被我找到了答案。")]),e._v(" "),t("h3",{attrs:{id:"解决问题"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#解决问题"}},[e._v("#")]),e._v(" 解决问题")]),e._v(" "),t("p",[e._v("具体issue: "),t("a",{attrs:{href:"https://github.com/sqlalchemy/sqlalchemy/issues/6121",target:"_blank",rel:"noopener noreferrer"}},[e._v("https://github.com/sqlalchemy/sqlalchemy/issues/6121"),t("OutboundLink")],1)]),e._v(" "),t("p",[t("img",{attrs:{src:"https://files.mdnice.com/user/11504/a32ff6ae-12bf-4cb9-a4c9-94741aa1e022.png",alt:""}})]),e._v(" "),t("p",[e._v("看看他的思路，其实很简单，"),t("code",[e._v("异步engine")]),e._v("提供了run_sync方法，这个很厉害，也就是说可以直接用异步engine去执行同步engine的方法，针对create_all（建表）+获取表信息，就很有用了，我们直接"),t("code",[e._v("学")]),e._v("过来，并给他一个小"),t("code",[e._v("红心")]),e._v("。")]),e._v(" "),t("ul",[t("li",[e._v("修改create_all")])]),e._v(" "),t("p",[t("img",{attrs:{src:"https://files.mdnice.com/user/11504/25edc36c-b291-4977-ad5e-a05454f54875.png",alt:""}})]),e._v(" "),t("p",[e._v("在底部定义create_table方法，由于是异步的，所以我们不能直接运行，但我们可以考虑放入startup里面，随着系统启动而执行。")]),e._v(" "),t("ul",[t("li",[e._v("修改main.py")])]),e._v(" "),t("p",[t("img",{attrs:{src:"https://files.mdnice.com/user/11504/e5d9a4fb-e462-43be-82d8-4411b999b983.png",alt:""}})]),e._v(" "),t("ul",[t("li",[t("p",[e._v("修改获取表的方法")]),e._v(" "),t("p",[e._v("先编写load_table方法，这里面由于需要"),t("code",[e._v("展示树")]),e._v("，所以多了很多额外的变量，核心的部分就是run_sync")])])]),e._v(" "),t("p",[t("img",{attrs:{src:"https://files.mdnice.com/user/11504/973bb935-16b4-4121-9dd2-dafdb47f7bb1.png",alt:""}})]),e._v(" "),t("ul",[t("li",[e._v("修改调用的部分")])]),e._v(" "),t("p",[t("img",{attrs:{src:"https://files.mdnice.com/user/11504/53afc48b-8d91-4eee-ad49-06a595cd4803.png",alt:""}})]),e._v(" "),t("p",[e._v("其实是把原先的逻辑，放入了一部分到table里面，好处是可以只遍历1次哦！")]),e._v(" "),t("h3",{attrs:{id:"放心去掉mysqlconnector"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#放心去掉mysqlconnector"}},[e._v("#")]),e._v(" 放心去掉mysqlconnector")]),e._v(" "),t("p",[t("img",{attrs:{src:"https://files.mdnice.com/user/11504/9ad3defa-f5f1-4541-be81-08e2fc9cb9d7.png",alt:""}})]),e._v(" "),t("p",[t("img",{attrs:{src:"https://files.mdnice.com/user/11504/6003e17d-93e1-41e2-8601-017af27c2f0b.png",alt:""}})]),e._v(" "),t("p",[e._v("这里引擎记得改为pymysql，实在没办法，我突然想到apscheduler不支持异步session，所以这个同步session还得继续用，但我们可以只用pymysql作为驱动了（支持异步和同步），所以我们把jdbc的驱动改为pymysql。")]),e._v(" "),t("p",[e._v("这样来看的话，基本也是做了一个完整的清理工作，说实话，速度还可以，有点小起飞。")]),e._v(" "),t("h3",{attrs:{id:"忍不住压测了一下"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#忍不住压测了一下"}},[e._v("#")]),e._v(" 忍不住压测了一下")]),e._v(" "),t("p",[e._v("找了个查询网关地址的接口，其中包括了"),t("code",[e._v("鉴权")]),e._v("，"),t("code",[e._v("db")]),e._v("操作，20个线程可以到300rps，还算满意，服务也不卡，对于一个"),t("code",[e._v("测试平台")]),e._v("来说，这样也就"),t("code",[e._v("够了")]),e._v("。")]),e._v(" "),t("p",[e._v("无法避免的是，我花了1个多小时，把所有同步session的操作都换成了异步。")]),e._v(" "),t("p",[t("img",{attrs:{src:"https://files.mdnice.com/user/11504/97b7f506-42f8-4656-b797-8d3ccd1c0cb5.png",alt:""}})]),e._v(" "),t("blockquote",[t("p",[e._v("我是米洛，一直陪伴各位学习！免费的"),t("code",[e._v("小黄心")]),e._v("，帮我点一个吧！")]),e._v(" "),t("p",[e._v("项目地址: "),t("a",{attrs:{href:"https://github.com/wuranxu/pity",target:"_blank",rel:"noopener noreferrer"}},[e._v("https://github.com/wuranxu/pity"),t("OutboundLink")],1)])])])}),[],!1,null,null,null);t.default=v.exports}}]);