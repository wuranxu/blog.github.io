(window.webpackJsonp=window.webpackJsonp||[]).push([[173],{585:function(t,s,a){"use strict";a.r(s);var e=a(2),n=Object(e.a)({},(function(){var t=this,s=t._self._c;return s("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[s("blockquote",[s("p",[t._v("大家好~我是"),s("code",[t._v("米洛")]),t._v("！"),s("br"),t._v("\n我正在从0到1打造一个开源的接口测试平台, 也在编写一套与之对应的完整"),s("code",[t._v("教程")]),t._v("，希望大家多多支持。"),s("br"),t._v("\n欢迎关注我的公众号"),s("code",[t._v("米洛的测开日记")]),t._v("，获取最新文章教程!")])]),t._v(" "),s("h3",{attrs:{id:"回顾"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#回顾"}},[t._v("#")]),t._v(" 回顾")]),t._v(" "),s("p",[t._v("上一节我们调研了一下市面上的"),s("strong",[t._v("定时任务")]),t._v("方案，最终确定为"),s("code",[t._v("APScheduler")]),t._v("，但据说在"),s("code",[t._v("uvicorn")]),t._v("下还有一些坑。")]),t._v(" "),s("p",[t._v("没关系，笔者也是在摸索阶段。如果有遇到问题，解决了也可以给大家参考。")]),t._v(" "),s("p",[t._v("这篇主要给大家介绍一下APScheduler的基本信息和使用方法。")]),t._v(" "),s("h3",{attrs:{id:"四个名词"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#四个名词"}},[t._v("#")]),t._v(" 四个名词")]),t._v(" "),s("p",[s("img",{attrs:{src:"https://static.pity.fun/picture/2021-10-30/1635565027549-image.png",alt:"官网讲的很详细"}})]),t._v(" "),s("ul",[s("li",[t._v("触发器: 定时任务什么时候触发")]),t._v(" "),s("li",[t._v("工作商店: 定时任务存在哪里，内存？MySQL?Redis?")]),t._v(" "),s("li",[t._v("执行器: 执行任务的程序")]),t._v(" "),s("li",[t._v("调度程序: 不同任务之间的调度管理程序，还包括任务的添加和修改等")])]),t._v(" "),s("h3",{attrs:{id:"存储介质"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#存储介质"}},[t._v("#")]),t._v(" 存储介质")]),t._v(" "),s("p",[t._v("在"),s("a",{attrs:{href:"http://mp.weixin.qq.com/s?__biz=MzAxMjc1OTkxMA==&mid=2247486521&idx=1&sn=777efa1eee2c6810af2250221f1a652e&chksm=9badaa30acda232655e592f5c08efacf26c1fd4846e4c595f8932b4ca44c1d241367e2bfa8e0#rd",target:"_blank",rel:"noopener noreferrer"}},[t._v("上一节"),s("OutboundLink")],1),t._v("我们提到了定时任务持久化。")]),t._v(" "),s("p",[t._v("那么在APScheduler中支持哪些"),s("code",[t._v("存储介质")]),t._v("呢？看一张图:")]),t._v(" "),s("p",[s("img",{attrs:{src:"https://static.pity.fun/picture/2021-10-30/1635564494838-image.png",alt:"图中很详细"}})]),t._v(" "),s("p",[t._v("可以看到，它支持多种介质，包括我们最不愿意用的"),s("code",[t._v("memory(内存)")]),t._v("。因为如果服务重启，数据就都没了，所以我们不考虑使用这个。")]),t._v(" "),s("ul",[s("li",[s("p",[t._v("SQLAlchemy")]),t._v(" "),s("p",[t._v("这是我们常用的方法，通过它可以写入到mysql，在不引入其他组件的情况下完全可以考虑。")])]),t._v(" "),s("li",[s("p",[t._v("MongoDB")]),t._v(" "),s("p",[t._v("NoSQL的一种，比较方便，我们"),s("code",[t._v("秉着不额外增加组件")]),t._v("的信念，暂不考虑。")])]),t._v(" "),s("li",[s("p",[t._v("Redis")]),t._v(" "),s("p",[t._v('redis后续我们自身服务也需要用到，但把它作为一个"数据库"来使用，还得考虑redis备份等情况，当然优点就是会比mysql更快。')]),t._v(" "),s("p",[t._v("至于其他的zk，rethinkdb，由于我们暂时也不会引用，所以不分析了。")]),t._v(" "),s("p",[t._v("综合而言，还是用SQLAlchemy"),s("code",[t._v("代价最小")]),t._v("，成本最低。")])])]),t._v(" "),s("h3",{attrs:{id:"运行模式"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#运行模式"}},[t._v("#")]),t._v(" 运行模式")]),t._v(" "),s("p",[t._v("在运行demo的过程中，发现APScheduler很强大，可以支持各种并发模式。")]),t._v(" "),s("p",[s("img",{attrs:{src:"https://static.pity.fun/picture/2021-10-30/1635564856495-image.png",alt:"采用谷歌翻译 翻译了一下，现在的翻译软件都很好用了"}})]),t._v(" "),s("p",[t._v("由于我们是异步Asycio，所以我们选择第三种执行器。其他的包括"),s("code",[t._v("Gevent")]),t._v("等也是Flask/Django等框架的好选择。")]),t._v(" "),s("h3",{attrs:{id:"了解基本api"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#了解基本api"}},[t._v("#")]),t._v(" 了解基本API")]),t._v(" "),s("ul",[s("li",[t._v("配置scheduler")])]),t._v(" "),s("div",{staticClass:"language-python line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-python"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("from")]),t._v(" apscheduler"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("jobstores"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("sqlalchemy "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" SQLAlchemyJobStore\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("from")]),t._v(" apscheduler"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("schedulers"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("asyncio "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" AsyncIOScheduler\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 选择job存储介质为sqlalchemy")]),t._v("\njob_store "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'default'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" SQLAlchemyJobStore"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("url"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("Config"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("SQLALCHEMY_DATABASE_URI"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 选择调度程序为AsyncIOScheduler")]),t._v("\nscheduler "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" AsyncIOScheduler"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 配置好对应的程序")]),t._v("\nscheduler"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("configure"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("jobstores"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("job_store"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 启动")]),t._v("\nscheduler"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("start"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br"),s("span",{staticClass:"line-number"},[t._v("2")]),s("br"),s("span",{staticClass:"line-number"},[t._v("3")]),s("br"),s("span",{staticClass:"line-number"},[t._v("4")]),s("br"),s("span",{staticClass:"line-number"},[t._v("5")]),s("br"),s("span",{staticClass:"line-number"},[t._v("6")]),s("br"),s("span",{staticClass:"line-number"},[t._v("7")]),s("br"),s("span",{staticClass:"line-number"},[t._v("8")]),s("br"),s("span",{staticClass:"line-number"},[t._v("9")]),s("br"),s("span",{staticClass:"line-number"},[t._v("10")]),s("br"),s("span",{staticClass:"line-number"},[t._v("11")]),s("br"),s("span",{staticClass:"line-number"},[t._v("12")]),s("br"),s("span",{staticClass:"line-number"},[t._v("13")]),s("br")])]),s("ul",[s("li",[t._v("添加job")])]),t._v(" "),s("div",{staticClass:"language-python line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-python"}},[s("code",[s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 把方法: myfunc添加到定时任务，每2分钟执行一次")]),t._v("\nscheduler"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("add_job"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("myfunc"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'interval'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" minutes"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("2")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("id")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'my_job_id'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br"),s("span",{staticClass:"line-number"},[t._v("2")]),s("br")])]),s("h3",{attrs:{id:"与pity结合"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#与pity结合"}},[t._v("#")]),t._v(" 与pity结合")]),t._v(" "),s("p",[t._v("在FastApi中，有个startup的钩子方法，意味着当服务启动的时候会自动执行该方法。我们来看看怎么用的:")]),t._v(" "),s("p",[s("img",{attrs:{src:"https://static.pity.fun/picture/2021-10-30/1635566693235-image.png",alt:""}})]),t._v(" "),s("p",[t._v("@pity.on_event意思是监听"),s("code",[t._v("事件")]),t._v('，后面的参数: "startup"代表pity服务启动。')]),t._v(" "),s("p",[t._v("也就是说，当pity启动的时候，则"),s("code",[t._v("初始化")]),t._v("Scheduler。")]),t._v(" "),s("p",[s("strong",[t._v("这里我封装了一个Scheduler类，后面会给大家介绍里面的具体方法。")])]),t._v(" "),s("p",[t._v("下一节我们编写"),s("code",[t._v("测试计划")]),t._v("相关接口，并与APScheduler结合起来，完成一整套定时任务功能。")])])}),[],!1,null,null,null);s.default=n.exports}}]);