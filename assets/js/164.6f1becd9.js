(window.webpackJsonp=window.webpackJsonp||[]).push([[164],{566:function(s,t,a){"use strict";a.r(t);var e=a(2),n=Object(e.a)({},(function(){var s=this,t=s._self._c;return t("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[t("blockquote",[t("p",[s._v("大家好~我是"),t("code",[s._v("米洛")]),s._v("！"),t("br"),t("br"),s._v("\n这是一个完整的"),t("code",[s._v("接口测试平台系列教程")]),s._v("，希望能和大家一起学习，从0到1打造一个开源平台。"),t("br"),s._v(" "),t("br"),s._v("\n欢迎关注我的公众号"),t("code",[s._v("米洛的测开日记")]),s._v("，获取最新文章教程!")])]),s._v(" "),t("h3",{attrs:{id:"回顾"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#回顾"}},[s._v("#")]),s._v(" 回顾")]),s._v(" "),t("p",[s._v("上一节我们基本上搞定了"),t("code",[s._v("数据构造器")]),s._v("的增删改等操作，这一篇我们来讲讲"),t("code",[s._v("软删除")]),s._v("相关的内容。")]),s._v(" "),t("h3",{attrs:{id:"什么是软删除"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#什么是软删除"}},[s._v("#")]),s._v(" 什么是软删除")]),s._v(" "),t("p",[s._v("先声明一下，我"),t("code",[s._v("没有")]),s._v("查阅关于具体"),t("code",[s._v("软删除")]),s._v("的资料，大家有兴趣的可以自己去搜索下，我说的都是自己的"),t("strong",[s._v("理解")]),s._v("。")]),s._v(" "),t("p",[s._v("删除数据，一般来说我们是从"),t("code",[s._v("数据库")]),s._v("或其他存储介质里面删除数据，举个🌰栗子:")]),s._v(" "),t("p",[s._v("我们需要把"),t("code",[s._v("数据表")]),s._v("里面的用户A删除掉，那我们最"),t("code",[s._v("常见")]),s._v("的方式就是:")]),s._v(" "),t("div",{staticClass:"language-SQL line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sql"}},[t("code",[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("delete")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("from")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("user")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("where")]),s._v(" name"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'A'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("p",[s._v("这个我理解的话，就是"),t("code",[s._v("物理删除")]),s._v("，删除了以后，我们的数据表里面"),t("code",[s._v("不再有这条数据的信息")]),s._v("，如果还需要这个用户，则需要重新insert一遍。")]),s._v(" "),t("p",[s._v("那"),t("code",[s._v("软删除")]),s._v("又是什么呢？软删除也可以叫做"),t("code",[s._v("逻辑删除")]),s._v("，比如我们给User表定义一个字段: deleted_at（"),t("strong",[s._v("代表这条数据删除的时间")]),s._v("），如果这个字段不为空，说明"),t("code",[s._v("用户未被删除")]),s._v(", 反之则说明"),t("code",[s._v("用户已经被删除了")]),s._v('。因为只是逻辑上的"删除"，并不是真正删掉了这条数据，所以又叫做逻辑删除。')]),s._v(" "),t("h2",{attrs:{id:"软删除的优点"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#软删除的优点"}},[s._v("#")]),s._v(" 软删除的优点")]),s._v(" "),t("p",[s._v("软删除对比物理删除的话，好处在哪呢？我认为有以下几个方面:")]),s._v(" "),t("ul",[t("li",[s._v("数据未被"),t("code",[s._v("真实删除")]),s._v("，数据更可靠")]),s._v(" "),t("li",[s._v("可以通过把删除的时间戳赋予给deleted_at，从而知道删除的时间，无形之中记录了用户的删除操作")]),s._v(" "),t("li",[s._v("对于用户而言和物理删除没什么区别")]),s._v(" "),t("li",[s._v("拥有天然的回收站功能")])]),s._v(" "),t("h2",{attrs:{id:"软删除的缺点"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#软删除的缺点"}},[s._v("#")]),s._v(" 软删除的缺点")]),s._v(" "),t("p",[s._v("上面提到了"),t("code",[s._v("软删除")]),s._v("的好处，这里就来说说软删除让人"),t("code",[s._v("又爱又恨")]),s._v("的地方。")]),s._v(" "),t("ul",[t("li",[t("p",[t("strong",[s._v("查询数据更加复杂")])]),s._v(" "),t("p",[s._v("查询条件需要带入"),t("strong",[s._v("deleted_at is null")]),s._v("，否则会查询出"),t("code",[s._v("被删除")]),s._v("的数据。")]),s._v(" "),t("p",[s._v("除了这个以外，还有一个比较棘手的问题，且听我慢慢道来。")])])]),s._v(" "),t("h3",{attrs:{id:"索引之殇"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#索引之殇"}},[s._v("#")]),s._v(" 索引之殇")]),s._v(" "),t("p",[s._v("索引这块是一个比较"),t("code",[s._v("棘手")]),s._v("的问题，特别是当我们有唯一索引的时候，我们先来看一种场景。")]),s._v(" "),t("ul",[t("li",[t("p",[s._v("用户表")]),s._v(" "),t("p",[s._v("我们的用户表里面有email字段，但email大家都懂的，是"),t("code",[s._v("不可以重复")]),s._v("的，所以我们需要给它加上"),t("code",[s._v("唯一索引")]),s._v("。")])])]),s._v(" "),t("h3",{attrs:{id:"场景一"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#场景一"}},[s._v("#")]),s._v(" 场景一")]),s._v(" "),t("p",[s._v("来看第一种场景，我们为用户表创建了一条数据：")]),s._v(" "),t("div",{staticClass:"language-Python line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-python"}},[t("code",[s._v("email  "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("123456")]),s._v("@qq"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("com\ndeleted_at "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" null\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br")])]),t("p",[s._v("我们这时候要"),t("code",[s._v("删除这条数据")]),s._v("，但因为软删除的原因我们会写这样的sql:")]),s._v(" "),t("div",{staticClass:"language-SQL line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sql"}},[t("code",[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("update")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("user")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("set")]),s._v(" deleted_at "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("now")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("where")]),s._v(" email"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'12345@qq.com'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("p",[s._v("你以为这就没事儿了吗？")]),s._v(" "),t("p",[s._v("接下来的事情就让人"),t("code",[s._v("脑崩")]),s._v("了，由于唯一索引"),t("code",[s._v("email_uidx")]),s._v("的存在，我没法再新插入一条email=123456@qq.com的数据了。")]),s._v(" "),t("p",[t("strong",[s._v("执行"),t("code",[s._v("插入语句")]),s._v("的时候，会报duplicate index的错误，相信大家也不少见。")])]),s._v(" "),t("p",[s._v("那这个问题怎么解决呢？我们来看看"),t("code",[s._v("场景二")]),s._v("。")]),s._v(" "),t("h2",{attrs:{id:"试着解决一下"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#试着解决一下"}},[s._v("#")]),s._v(" 试着解决一下")]),s._v(" "),t("p",[s._v("为了解决场景一的"),t("code",[s._v("唯一索引")]),s._v("问题，我们想到了"),t("code",[s._v("联合索引")]),s._v("，啥子叫联合唯一索引呢？就是多个字段同时相同的时候，数据才算重复，也就是触发"),t("code",[s._v("duplicate index")]),s._v("报错。")]),s._v(" "),t("p",[s._v("于是我们创建一个联合唯一索引:")]),s._v(" "),t("div",{staticClass:"language-SQL line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sql"}},[t("code",[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("ALTER")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("TABLE")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("user")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("ADD")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("UNIQUE")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("INDEX")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("email"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" deleted_at"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("p",[s._v("这时候，我们再来看场景一:")]),s._v(" "),t("ul",[t("li",[s._v("创建用户")])]),s._v(" "),t("div",{staticClass:"language-Python line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-python"}},[t("code",[s._v("email"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("12345")]),s._v("@qq"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("com\ndeleted_at"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("null\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br")])]),t("p",[s._v("接着，我们删除之，这时候它变成了:")]),s._v(" "),t("div",{staticClass:"language-Python line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-python"}},[t("code",[s._v("email"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("12345")]),s._v("@qq"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("com\ndeleted_at"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2021")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("09")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("12")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("20")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("13")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("00")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br")])]),t("p",[s._v("然后我们继续添加"),t("code",[s._v("12345@qq.com")]),s._v("的用户，发现"),t("code",[s._v("可以添加了")]),s._v("。")]),s._v(" "),t("p",[s._v("你以为这就"),t("code",[s._v("完事")]),s._v("了？那我们再看看场景二:")]),s._v(" "),t("h3",{attrs:{id:"场景二"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#场景二"}},[s._v("#")]),s._v(" 场景二")]),s._v(" "),t("p",[s._v("这个比较简单，我们insert2条相同的数据:")]),s._v(" "),t("div",{staticClass:"language-sql line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sql"}},[t("code",[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("insert")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("into")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("user")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("email"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" deleted_at"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("values")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'12345@qq.com'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("null")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("insert")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("into")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("user")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("email"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" deleted_at"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("values")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'12345@qq.com'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("null")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br")])]),t("p",[s._v("好久没写sql，也不知道写的对不对，凑合看，大概是这么个意思。")]),s._v(" "),t("p",[s._v("这时候"),t("code",[s._v("奇迹出现了")]),s._v("，可以发现2条数据都插入成功了，也就是说，之前的email的"),t("code",[s._v("唯一性")]),s._v("得不到保证了。")]),s._v(" "),t("h2",{attrs:{id:"这是为什么呢"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#这是为什么呢"}},[s._v("#")]),s._v(" 这是为什么呢？")]),s._v(" "),t("p",[s._v("原来，当联合索引里面有字段为null的时候，联合索引会"),t("code",[s._v("自动失效")]),s._v("。")]),s._v(" "),t("p",[s._v("那这个真的是"),t("code",[s._v("非常难受")]),s._v("，可谓是修复了一个bug又导致了另一个bug。")]),s._v(" "),t("h3",{attrs:{id:"解决方案一"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#解决方案一"}},[s._v("#")]),s._v(" 解决方案一")]),s._v(" "),t("p",[s._v("其实我们可以把"),t("code",[s._v("deleted_at")]),s._v("设置为和主键一样的自增id，每当被删除的时候就+1，恢复的时候也+1，默认为0，这样也不会因为默认为NULL而引发唯一索引失效。")]),s._v(" "),t("h3",{attrs:{id:"解决方案二"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#解决方案二"}},[s._v("#")]),s._v(" 解决方案二")]),s._v(" "),t("p",[s._v("我们可以把"),t("code",[s._v("deleted_at")]),s._v("设置为时间戳，默认为0（代表未删除），一般来说，手动操作"),t("code",[s._v("删除操作")]),s._v("时间戳肯定有细微变化，这样索引将不会生效，也就是不会影响到之前的数据。")]),s._v(" "),t("p",[s._v("但也有一个缺点: 如果一个数据被删除多次，数据库将存在"),t("code",[s._v("许多")]),s._v("相同的被删除的数据，当然一般人也不会做辣么无聊的事情。")]),s._v(" "),t("div",{staticClass:"language-python line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-python"}},[t("code",[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("class")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Model")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("Base"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    deleted_at "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" Column"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("BIGINT"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" nullable"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("False")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" default"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br")])]),t("p",[s._v("可以看到deleted_at如此定义，当有删除操作的时候，我们设置deleted_at = time.time()即可。")]),s._v(" "),t("div",{staticClass:"language-python line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-python"}},[t("code",[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("import")]),s._v(" time\nmodel"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("deleted_at "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" time"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("time"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br")])]),t("p",[s._v("大家如果有更合适的方案，也欢迎"),t("code",[s._v("一起探讨")]),s._v("~感激不尽！~")])])}),[],!1,null,null,null);t.default=n.exports}}]);