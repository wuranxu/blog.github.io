(window.webpackJsonp=window.webpackJsonp||[]).push([[176],{587:function(t,s,a){"use strict";a.r(s);var n=a(2),e=Object(n.a)({},(function(){var t=this,s=t._self._c;return s("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[s("blockquote",[s("p",[t._v("大家好~我是"),s("code",[t._v("米洛")]),t._v("！"),s("br"),t._v("\n我正在从0到1打造一个开源的接口测试平台, 也在编写一套与之对应的完整"),s("code",[t._v("教程")]),t._v("，希望大家多多支持。"),s("br"),t._v("\n欢迎关注我的公众号"),s("code",[t._v("米洛的测开日记")]),t._v("，获取最新文章教程!")])]),t._v(" "),s("h3",{attrs:{id:"回顾"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#回顾"}},[t._v("#")]),t._v(" 回顾")]),t._v(" "),s("p",[t._v("上一节我们写好了一个"),s("code",[t._v("测试计划")]),t._v("的初级版本，并且能够添加计划，也能定时执行。那今天我们就来完善测试计划"),s("code",[t._v("删改查")]),t._v("与APScheduler相结合的部分。")]),t._v(" "),s("h3",{attrs:{id:"定时任务和测试计划的耦合"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#定时任务和测试计划的耦合"}},[t._v("#")]),t._v(" 定时任务和测试计划的耦合")]),t._v(" "),s("p",[t._v("目前来看，测试计划和定时任务有着高度的耦合，考虑到我们"),s("code",[t._v("并不打算做一款自由度高的定时job系统")]),t._v("，所以暂时就先按这个思路设计。毕竟我们是一个做接口自动化的平台，而不是类似"),s("code",[t._v("jenkins")]),t._v("一样，有各类任务的平台。如果后续有相关的需求，我们再考虑。")]),t._v(" "),s("p",[t._v("所以现在的情况是，定时任务列表存放了一批"),s("code",[t._v("job数据")]),t._v("，测试计划表又存放了与之对应的测试计划数据。")]),t._v(" "),s("h3",{attrs:{id:"查询定时任务"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#查询定时任务"}},[t._v("#")]),t._v(" 查询定时任务")]),t._v(" "),s("p",[t._v("我们之前不是添加过一个定时任务吗？我们先来看看用APScheduler的api，获取到的数据内容。这时候就需要debug了~")]),t._v(" "),s("p",[t._v("Scheduler对象是有个get_job的方法，我们之前给job的id定义为测试计划的id。")]),t._v(" "),s("p",[t._v("所以我们现在可以用测试计划的id去查询定时任务的一些信息。")]),t._v(" "),s("p",[t._v("在utils/scheduler.py新增list_test_plan方法:")]),t._v(" "),s("div",{staticClass:"language-python line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-python"}},[s("code",[t._v("    "),s("span",{pre:!0,attrs:{class:"token decorator annotation punctuation"}},[t._v("@staticmethod")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("def")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("list_test_plan")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("data"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" List"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("for")]),t._v(" d "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("in")]),t._v(" data"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n            job "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" Scheduler"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("scheduler"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("get_job"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("str")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("d"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("get"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'id'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n            "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("print")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("job"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n            d"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"next_run"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" job"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("next_run_time\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br"),s("span",{staticClass:"line-number"},[t._v("2")]),s("br"),s("span",{staticClass:"line-number"},[t._v("3")]),s("br"),s("span",{staticClass:"line-number"},[t._v("4")]),s("br"),s("span",{staticClass:"line-number"},[t._v("5")]),s("br"),s("span",{staticClass:"line-number"},[t._v("6")]),s("br")])]),s("p",[t._v("传入的data是查询测试计划接口拿到的"),s("code",[t._v("测试计划数据")]),t._v("。")]),t._v(" "),s("p",[s("img",{attrs:{src:"https://static.pity.fun/picture/2021-11-6/1636166699222-image.png",alt:""}})]),t._v(" "),s("p",[t._v("过程如下:")]),t._v(" "),s("ol",[s("li",[t._v("获取到测试计划数据")]),t._v(" "),s("li",[t._v("根据测试计划数据去获取到定时任务的数据")]),t._v(" "),s("li",[t._v("一并返回")])]),t._v(" "),s("p",[s("img",{attrs:{src:"https://static.pity.fun/picture/2021-11-6/1636167413507-image.png",alt:"看看一个job返回的数据"}})]),t._v(" "),s("p",[t._v("其实我这里弱化了定时任务的特点，反而把cron这样的字段剥离到"),s("code",[t._v("测试计划")]),t._v("之中了。所以这个定时任务给我们的作用就只有2个:")]),t._v(" "),s("ul",[s("li",[s("p",[t._v("它是不是存在")])]),t._v(" "),s("li",[s("p",[t._v("它是否正常工作，可以通过next_run_at来判断")]),t._v(" "),s("p",[t._v("所以我们只需要在查询接口，加上next_run_at就可以了。")])])]),t._v(" "),s("p",[s("img",{attrs:{src:"https://static.pity.fun/picture/2021-11-6/1636167597327-image.png",alt:"可以看到，我们是没有2这个测试计划的，所以查出来的job是None"}})]),t._v(" "),s("p",[t._v("这点很重要，因为我们可能"),s("code",[t._v("创建测试计划成功")]),t._v("了，但"),s("code",[t._v("创建定时任务失败")]),t._v("了。所以这个数据不可忽略。")]),t._v(" "),s("p",[t._v("当我们没获取到job的时候，把job的state改为2（并非在数据库改），只是在页面上显示这个测试计划任务未添加成功！！！")]),t._v(" "),s("p",[s("img",{attrs:{src:"https://static.pity.fun/picture/2021-11-6/1636168136795-image.png",alt:"获取定时计划的最终结果如下"}})]),t._v(" "),s("h3",{attrs:{id:"编写编辑-删除定时任务方法"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#编写编辑-删除定时任务方法"}},[t._v("#")]),t._v(" 编写编辑/删除定时任务方法")]),t._v(" "),s("p",[t._v("由于APS本身就提供了良好的api，所以我们简易封装一下即可。")]),t._v(" "),s("div",{staticClass:"language-python line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-python"}},[s("code",[t._v("    "),s("span",{pre:!0,attrs:{class:"token decorator annotation punctuation"}},[t._v("@staticmethod")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("def")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("edit_test_plan")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("plan_id"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" plan_name"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" cron"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token triple-quoted-string string"}},[t._v('"""\n        通过测试计划id，更新测试计划任务的cron，name等数据\n        :param plan_id:\n        :param plan_name:\n        :param cron:\n        :return:\n        """')]),t._v("\n        Scheduler"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("scheduler"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("modify_job"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("job_id"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("str")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("plan_id"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" trigger"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("CronTrigger"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("from_crontab"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("cron"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" name"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("plan_name"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\n    "),s("span",{pre:!0,attrs:{class:"token decorator annotation punctuation"}},[t._v("@staticmethod")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("def")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("pause_resume_test_plan")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("plan_id"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" status"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token triple-quoted-string string"}},[t._v('"""\n        暂停或恢复测试计划，会影响到next_run_at\n        :param plan_id:\n        :param status:\n        :return:\n        """')]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" status"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n            Scheduler"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("scheduler"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("resume_job"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("job_id"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("str")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("plan_id"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("else")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n            Scheduler"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("scheduler"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("pause_job"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("job_id"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("str")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("plan_id"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\n    "),s("span",{pre:!0,attrs:{class:"token decorator annotation punctuation"}},[t._v("@staticmethod")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("def")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("remove")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("plan_id"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token triple-quoted-string string"}},[t._v('"""\n        删除job，当删除测试计划时，调用此方法\n        :param plan_id:\n        :return:\n        """')]),t._v("\n        Scheduler"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("scheduler"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("remove_job"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("str")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("plan_id"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br"),s("span",{staticClass:"line-number"},[t._v("2")]),s("br"),s("span",{staticClass:"line-number"},[t._v("3")]),s("br"),s("span",{staticClass:"line-number"},[t._v("4")]),s("br"),s("span",{staticClass:"line-number"},[t._v("5")]),s("br"),s("span",{staticClass:"line-number"},[t._v("6")]),s("br"),s("span",{staticClass:"line-number"},[t._v("7")]),s("br"),s("span",{staticClass:"line-number"},[t._v("8")]),s("br"),s("span",{staticClass:"line-number"},[t._v("9")]),s("br"),s("span",{staticClass:"line-number"},[t._v("10")]),s("br"),s("span",{staticClass:"line-number"},[t._v("11")]),s("br"),s("span",{staticClass:"line-number"},[t._v("12")]),s("br"),s("span",{staticClass:"line-number"},[t._v("13")]),s("br"),s("span",{staticClass:"line-number"},[t._v("14")]),s("br"),s("span",{staticClass:"line-number"},[t._v("15")]),s("br"),s("span",{staticClass:"line-number"},[t._v("16")]),s("br"),s("span",{staticClass:"line-number"},[t._v("17")]),s("br"),s("span",{staticClass:"line-number"},[t._v("18")]),s("br"),s("span",{staticClass:"line-number"},[t._v("19")]),s("br"),s("span",{staticClass:"line-number"},[t._v("20")]),s("br"),s("span",{staticClass:"line-number"},[t._v("21")]),s("br"),s("span",{staticClass:"line-number"},[t._v("22")]),s("br"),s("span",{staticClass:"line-number"},[t._v("23")]),s("br"),s("span",{staticClass:"line-number"},[t._v("24")]),s("br"),s("span",{staticClass:"line-number"},[t._v("25")]),s("br"),s("span",{staticClass:"line-number"},[t._v("26")]),s("br"),s("span",{staticClass:"line-number"},[t._v("27")]),s("br"),s("span",{staticClass:"line-number"},[t._v("28")]),s("br"),s("span",{staticClass:"line-number"},[t._v("29")]),s("br"),s("span",{staticClass:"line-number"},[t._v("30")]),s("br"),s("span",{staticClass:"line-number"},[t._v("31")]),s("br"),s("span",{staticClass:"line-number"},[t._v("32")]),s("br")])]),s("p",[t._v("这边已经都写好了"),s("code",[t._v("注释")]),t._v("，至于为什么我们需要"),s("code",[t._v("pause和resume方法呢")]),t._v("，是因为有时候我们可能不太想跑这个任务，我们想先暂停一下，所以有这个情况发生。")]),t._v(" "),s("h3",{attrs:{id:"修改对应的接口"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#修改对应的接口"}},[t._v("#")]),t._v(" 修改对应的接口")]),t._v(" "),s("p",[s("img",{attrs:{src:"https://static.pity.fun/picture/2021-11-6/1636168423708-image.png",alt:"红线部分是修改的地方，此外我们新增了一个switch接口，用于开关定时任务"}})]),t._v(" "),s("p",[t._v("我们来测试下暂停功能:")]),t._v(" "),s("ul",[s("li",[t._v("暂停之前获取测试计划列表")])]),t._v(" "),s("p",[s("img",{attrs:{src:"https://static.pity.fun/picture/2021-11-6/1636168504845-image.png",alt:""}})]),t._v(" "),s("ul",[s("li",[t._v("暂停之后")])]),t._v(" "),s("p",[s("img",{attrs:{src:"https://static.pity.fun/picture/2021-11-6/1636168580018-image.png",alt:""}})]),t._v(" "),s("p",[t._v("可以看到，由于next_run_at为None了，所以我们之前的strftime失效了。")]),t._v(" "),s("p",[t._v("所以我们要做下调整:")]),t._v(" "),s("p",[s("img",{attrs:{src:"https://static.pity.fun/picture/2021-11-6/1636168761603-image.png",alt:""}})]),t._v(" "),s("p",[t._v("所以我们testplan有了3个状态:")]),t._v(" "),s("ul",[s("li",[s("p",[t._v("0：等待中")])]),t._v(" "),s("li",[s("p",[t._v("1: 执行中")])]),t._v(" "),s("li",[s("p",[t._v("2: 定时任务未添加")])]),t._v(" "),s("li",[s("p",[t._v("3: 定时任务已暂停")]),t._v(" "),s("p",[t._v("有了这些数据，我们前端就知道要怎么展示测试计划的定时任务状态了。")]),t._v(" "),s("p",[t._v("下一节我们就要开始编写"),s("code",[t._v("测试计划页面")]),t._v("的前端部分了。")])])])])}),[],!1,null,null,null);s.default=e.exports}}]);