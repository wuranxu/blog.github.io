(window.webpackJsonp=window.webpackJsonp||[]).push([[152],{562:function(t,s,a){"use strict";a.r(s);var n=a(2),e=Object(n.a)({},(function(){var t=this,s=t._self._c;return s("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[s("blockquote",[s("p",[t._v("大家好，我是米洛，求三连！求关注"),s("code",[t._v("米洛的测开日记")]),t._v("!")])]),t._v(" "),s("h3",{attrs:{id:"回顾"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#回顾"}},[t._v("#")]),t._v(" 回顾")]),t._v(" "),s("p",[t._v("上节我们编写了"),s("code",[t._v("异步sql连接")]),t._v("的功能，经过博主一番激烈的思想斗争，还是决定暂时先使用"),s("code",[t._v("同步")]),t._v("的方式。")]),t._v(" "),s("p",[t._v("为什么呢？主要是以下几个原因:")]),t._v(" "),s("ul",[s("li",[s("p",[t._v("异步("),s("code",[t._v("AsyncEngine")]),t._v(")的功能还很多都不完善")]),t._v(" "),s("p",[t._v("举个例子，为了让"),s("code",[t._v("在线执行SQL")]),t._v("功能更加友好，并且防止用户写错表名，我们需要展示出db下有哪些表，如果能展示出表有什么字段，那就更完美了！但"),s("code",[t._v("异步Engine")]),t._v("的话，还确实很多功能都是"),s("code",[t._v("支持不了")]),t._v("的，还需要等他们慢慢完善。")])]),t._v(" "),s("li",[s("p",[t._v("pg的异步库还没选定")]),t._v(" "),s("p",[t._v("虽然有一定的方向，比如GINO这样的引擎都做了一些sqlalchemy的功能，并不只是单纯的异步数据库driver。而同步的，我们可以用现有的"),s("code",[t._v("psycopg2")]),t._v("。")])]),t._v(" "),s("li",[s("p",[t._v("异步同步性能差距目前来看不算大")])])]),t._v(" "),s("h3",{attrs:{id:"开始改造"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#开始改造"}},[t._v("#")]),t._v(" 开始改造")]),t._v(" "),s("ul",[s("li",[t._v("修改get_jdbc_url方法")])]),t._v(" "),s("p",[s("img",{attrs:{src:"https://static.pity.fun/picture/2021-8-21/1629536614481-image.png",alt:"mysql使用官方的mysql-connetor，pg使用psycopg2"}})]),t._v(" "),s("ul",[s("li",[t._v("修改test_connection方法")])]),t._v(" "),s("p",[s("img",{attrs:{src:"https://static.pity.fun/picture/2021-8-21/1629536666798-image.png",alt:"去掉了async相关代码"}})]),t._v(" "),s("ul",[s("li",[t._v("修改get_connection方法")])]),t._v(" "),s("p",[s("img",{attrs:{src:"https://static.pity.fun/picture/2021-8-21/1629536711057-image.png",alt:"除了改掉了异步代码以外，注箭头处"}})]),t._v(" "),s("p",[t._v("这边缓存了engine和session2个变量，而不只是单纯的session，因为我们获取数据库有哪些表，需要用到"),s("code",[t._v("engine")]),t._v("。")]),t._v(" "),s("p",[t._v("虽然说"),s("code",[t._v("show tables")]),t._v("也可以拿到表信息，但是不够全面。")]),t._v(" "),s("h3",{attrs:{id:"编写在线执行sql的方法"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#编写在线执行sql的方法"}},[t._v("#")]),t._v(" 编写在线执行SQL的方法")]),t._v(" "),s("p",[t._v("在DbConfigDao.py文件中增加online_sql方法，接受2个参数:")]),t._v(" "),s("ul",[s("li",[t._v("数据库配置id")]),t._v(" "),s("li",[t._v("sql 具体的sql语句")])]),t._v(" "),s("p",[s("img",{attrs:{src:"https://static.pity.fun/picture/2021-8-21/1629536914923-image.png",alt:""}})]),t._v(" "),s("p",[s("img",{attrs:{src:"https://static.pity.fun/picture/2021-8-21/1629539900552-image.png",alt:""}})]),t._v(" "),s("p",[s("img",{attrs:{src:"https://static.pity.fun/picture/2021-8-21/1629539914916-image.png",alt:""}})]),t._v(" "),s("p",[t._v("可以看到，我们先通过get_connection获取到这个配置的连接session，然后execute执行了sql语句，最后调用:")]),t._v(" "),s("div",{staticClass:"language-Python line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-python"}},[s("code",[t._v("result"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("mappings"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("all")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br")])]),s("p",[t._v("拿到返回数据，这个mappings()的好处是什么呢？就是可以把执行结果按照下面的格式返回，当然也是"),s("code",[t._v("查了许久")]),t._v("得出的结果。")]),t._v(" "),s("div",{staticClass:"language-Json line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-json"}},[s("code",[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),s("span",{pre:!0,attrs:{class:"token property"}},[t._v('"字段1"')]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"字段1的值"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br"),s("span",{staticClass:"line-number"},[t._v("2")]),s("br"),s("span",{staticClass:"line-number"},[t._v("3")]),s("br")])]),s("h3",{attrs:{id:"编写接口"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#编写接口"}},[t._v("#")]),t._v(" 编写接口")]),t._v(" "),s("p",[s("img",{attrs:{src:"https://static.pity.fun/picture/2021-8-21/1629537046980-image.png",alt:"新增了online路由"}})]),t._v(" "),s("p",[t._v("这里的参数是配置id和sql语句，我们来看看对应的返回结果:")]),t._v(" "),s("p",[s("img",{attrs:{src:"https://static.pity.fun/picture/2021-8-21/1629537089624-image.png",alt:""}})]),t._v(" "),s("p",[s("img",{attrs:{src:"https://static.pity.fun/picture/2021-8-21/1629537117055-image.png",alt:""}})]),t._v(" "),s("p",[s("img",{attrs:{src:"https://static.pity.fun/picture/2021-8-21/1629537134393-image.png",alt:""}})]),t._v(" "),s("p",[t._v("可以看到，基本上就是原生执行sql了，"),s("code",[t._v("非常好用")]),t._v("!因为本人目前电脑没有装pg，所以对pg的兼容性可能不是很好，大家有疑问的话可以给我提issue，我会"),s("code",[t._v("尽快兼容")]),t._v("的。")]),t._v(" "),s("p",[t._v("项目地址: "),s("a",{attrs:{href:"https://github.com/wuranxu/pity",target:"_blank",rel:"noopener noreferrer"}},[t._v("https://github.com/wuranxu/pity"),s("OutboundLink")],1)]),t._v(" "),s("p",[t._v("因为同步异步的方法，有一些耽搁了进度，不要紧，下一节后端的内容会偏少，主要讲怎么想datagrip一样展示"),s("code",[t._v("数据表")]),t._v("结构，并让用户可以"),s("code",[t._v("在线编写sql")]),t._v("，最终就是嵌入到"),s("code",[t._v("数据构造器")]),t._v("（前置条件）之中。")]),t._v(" "),s("p",[t._v("PS: 项目有了新的域名了，大家可以通过下面的网址在线体验。这个域名我一口气买了10年，希望自己也能"),s("code",[t._v("继续维护")]),t._v("下去~")]),t._v(" "),s("blockquote",[s("p",[s("code",[t._v("http://test.pity.fun")])])])])}),[],!1,null,null,null);s.default=e.exports}}]);