(window.webpackJsonp=window.webpackJsonp||[]).push([[155],{557:function(t,a,s){"use strict";s.r(a);var e=s(2),_=Object(e.a)({},(function(){var t=this,a=t._self._c;return a("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[a("blockquote",[a("p",[t._v("大家好，我是米洛，求三连！求关注"),a("code",[t._v("米洛的测开日记")]),t._v("!")])]),t._v(" "),a("h3",{attrs:{id:"回顾"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#回顾"}},[t._v("#")]),t._v(" 回顾")]),t._v(" "),a("p",[t._v("上一篇我们编写了树的最外层，但是因为我们还有"),a("code",[t._v("很深的层级")]),t._v("要嵌套，所以我们现在开始。")]),t._v(" "),a("p",[t._v("准备好了吗？")]),t._v(" "),a("p",[a("code",[t._v("本文依旧有一定的难度，需要大家理解值传递和引用传递")]),t._v("。")]),t._v(" "),a("p",[t._v("先看看最终效果图，来点信心。")]),t._v(" "),a("p",[a("img",{attrs:{src:"https://static.pity.fun/picture/2021-8-21/1629561252310-image.png",alt:""}})]),t._v(" "),a("h3",{attrs:{id:"实现伪代码"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#实现伪代码"}},[t._v("#")]),t._v(" 实现伪代码")]),t._v(" "),a("p",[t._v("上一节我们写的都是"),a("code",[t._v("伪代码")]),t._v("，这次直接来实现它。")]),t._v(" "),a("p",[a("img",{attrs:{src:"https://static.pity.fun/picture/2021-8-21/1629559398349-image.png",alt:"编写方法，查询数据库和数据表"}})]),t._v(" "),a("p",[a("code",[t._v("result")]),t._v("是我们最终返回结果。")]),t._v(" "),a("p",[t._v("最外层我们先查询所有的"),a("code",[t._v("环境")]),t._v("，并生成一个映射关系:")]),t._v(" "),a("p",[a("code",[t._v("环境id => 环境名称")])]),t._v(" "),a("h2",{attrs:{id:"为什么需要env-index"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#为什么需要env-index"}},[t._v("#")]),t._v(" 为什么需要env_index")]),t._v(" "),a("p",[t._v("那么"),a("code",[t._v("env_index")]),t._v("又是干什么的呢？")]),t._v(" "),a("p",[a("strong",[t._v('因为环境是最外层，我们需要通过环境id找到我们要往哪个环境的children里面加第二层的数据，而我们生成的是一个列表，这就导致如果我们需要插入环境id=2的children的时候，不得不去搜索一次result，从result里面找到id="env_2"的那条数据，接着去append到他的children。')])]),t._v(" "),a("p",[t._v("这样时间复杂度会非常高，但是如果我们提前记录了，我环境id=2的时候插入到result的第几个children，那么就省略了从数组中查询的那步，等于用"),a("code",[t._v("空间")]),t._v("（env_idx）换了"),a("code",[t._v("查询的时间")]),t._v("。")]),t._v(" "),a("h2",{attrs:{id:"完成第一层数据录入"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#完成第一层数据录入"}},[t._v("#")]),t._v(" 完成第一层数据录入")]),t._v(" "),a("p",[a("img",{attrs:{src:"https://static.pity.fun/picture/2021-8-21/1629559688982-image.png",alt:"接着获取session，并查出所有没被删除的database数据"}})]),t._v(" "),a("p",[a("img",{attrs:{src:"https://static.pity.fun/picture/2021-8-21/1629560097745-image.png",alt:""}})]),t._v(" "),a("p",[t._v("可以看到，我们遍历拿到的"),a("code",[t._v("PityDatabase")]),t._v("数据，接着从env_map里把"),a("code",[t._v("环境id")]),t._v("转为"),a("code",[t._v("环境名")]),t._v("。")]),t._v(" "),a("p",[t._v("再开始判断env_index里面环境名的索引，在result的第几个，如果没有的话，说明result里面还没有这个环境的任何数据。")]),t._v(" "),a("p",[t._v("那我们就插入一条"),a("code",[t._v("环境数据")]),t._v("。")]),t._v(" "),a("div",{staticClass:"language-Python line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-python"}},[a("code",[t._v("result"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("append"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("dict")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("title"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("name"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" key"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),a("span",{pre:!0,attrs:{class:"token string-interpolation"}},[a("span",{pre:!0,attrs:{class:"token string"}},[t._v('f"env_')]),a("span",{pre:!0,attrs:{class:"token interpolation"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("name"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")])]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"')])]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" children"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),a("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("list")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br")])]),a("p",[t._v("那此时result就变成了:")]),t._v(" "),a("div",{staticClass:"language-JSON line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-json"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("title"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"fat"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" key"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"env_3"')]),t._v(". children"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br")])]),a("p",[t._v("这是环境3在result的索引肯定是数组的最后一个元素，因为我们刚刚才append进去的，所以idx = len(result)-1")]),t._v(" "),a("p",[t._v("接着我们把idx存起来，这个可以理解的吧~")]),t._v(" "),a("p",[a("code",[t._v("MetaData")]),t._v("是我们获取数据表的关键，为了避免重复生成，我这边只在最外层生成了，传递给"),a("code",[t._v("get_tables")]),t._v("方法。")]),t._v(" "),a("h3",{attrs:{id:"实现内层数据"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#实现内层数据"}},[t._v("#")]),t._v(" 实现内层数据")]),t._v(" "),a("p",[t._v("注意这里我用get_tables方法的时候，将result[idx]['children']参数传了进去，意味着"),a("code",[t._v("后续所有的数据")]),t._v("都会append到这个children里面去，"),a("code",[t._v("十分方便")]),t._v("。")]),t._v(" "),a("p",[t._v("而children是个list，list是"),a("code",[t._v("引用传递")]),t._v("的。所以我在get_tables里面对list的改动，其实也是生效的，可以看到get_tables没有任何返回，那是因为我的result里头的children被改掉了，导致了我的result间接被改掉了，"),a("code",[t._v("就这个道理")]),t._v("。")]),t._v(" "),a("h2",{attrs:{id:"看看get-tables怎么写"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#看看get-tables怎么写"}},[t._v("#")]),t._v(" 看看get_tables怎么写")]),t._v(" "),a("p",[a("img",{attrs:{src:"https://static.pity.fun/picture/2021-8-21/1629560320541-image.png",alt:""}})]),t._v(" "),a("ol",[a("li",[a("p",[t._v("我们先通过db_helper获取到当时的连接conn，里面包含了session和engine，还记得不？")])]),t._v(" "),a("li",[a("p",[t._v("我们再次新建一个list，叫database_child，看名字就知道，他是database再下面一层的数据。")])]),t._v(" "),a("li",[a("p",[t._v("我们编写当前database层的节点数据，其实就是个dict，title因为我们需要展示对应的数据库ip+port，所以是这样:")])])]),t._v(" "),a("p",[a("code",[t._v('f"{data.database}（{data.host}:{data.port}）"')])]),t._v(" "),a("p",[t._v("因为database有唯一id，所以key可以叫『database_{data.id}』")]),t._v(" "),a("p",[t._v("children即是上一步创建的list().")]),t._v(" "),a("ol",{attrs:{start:"4"}},[a("li",[a("p",[t._v("获取engine")])]),t._v(" "),a("li",[a("p",[t._v("meta获取表信息")])]),t._v(" "),a("li",[a("p",[t._v("遍历表")])])]),t._v(" "),a("p",[t._v("这边再次说明一下，get_tables参数中的children，是环境的下一层，database_child是数据库的下一层，而dbs则是当前层次。")]),t._v(" "),a("p",[t._v("遍历表了以后，我们临时创建temp数组（temp是数据表的下一层，实际上存的是"),a("code",[t._v("字段信息")]),t._v("。）")]),t._v(" "),a("p",[a("img",{attrs:{src:"https://static.pity.fun/picture/2021-8-21/1629560662414-image.png",alt:"这段代码是把table这一层加到database_child数组里面去"}})]),t._v(" "),a("p",[t._v("大家如果实在看不明白，以key为标准:")]),t._v(" "),a("ul",[a("li",[t._v("key以env开头说明是环境层")]),t._v(" "),a("li",[t._v("以database开头说明是数据库层")]),t._v(" "),a("li",[t._v("以table开头说明是数据表层")]),t._v(" "),a("li",[t._v("以column开头说明是字段层")])]),t._v(" "),a("ol",{attrs:{start:"7"}},[a("li",[t._v("遍历字段数据，并把对应的字段加到temp数组，因为"),a("code",[t._v("改了temp数组")]),t._v("，所以实际上database_child(表那一层)也得到了改动。")])]),t._v(" "),a("p",[a("img",{attrs:{src:"https://static.pity.fun/picture/2021-8-21/1629560798223-image.png",alt:"primary_key字段代表是否是主键"}})]),t._v(" "),a("ol",{attrs:{start:"8"}},[a("li",[t._v("最终把咱们这一层的dbs->带有表数据->带有字段数据，给加入到刚才传递给咱们的children数组中。")])]),t._v(" "),a("p",[a("img",{attrs:{src:"https://static.pity.fun/picture/2021-8-21/1629560848076-image.png",alt:""}})]),t._v(" "),a("h3",{attrs:{id:"查看完成数据"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#查看完成数据"}},[t._v("#")]),t._v(" 查看完成数据")]),t._v(" "),a("p",[a("img",{attrs:{src:"https://static.pity.fun/picture/2021-8-21/1629560972434-image.png",alt:""}})]),t._v(" "),a("p",[a("img",{attrs:{src:"https://static.pity.fun/picture/2021-8-21/1629561041245-image.png",alt:"可以看到数据正常展示了，和前端需要的一样"}})]),t._v(" "),a("p",[t._v("这样"),a("code",[t._v("前端仔")]),t._v("就不会再纠结数据怎么转换了，"),a("code",[t._v("非常好用")]),t._v("！")]),t._v(" "),a("h2",{attrs:{id:"看看实战效果"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#看看实战效果"}},[t._v("#")]),t._v(" 看看实战效果")]),t._v(" "),a("p",[t._v("由于"),a("code",[t._v("原生组件")]),t._v("提供的图标啥的都比较粗糙，我们需要进行一下调整。")]),t._v(" "),a("p",[t._v("再来一发效果图，由于右侧的"),a("code",[t._v("SQL编辑器")]),t._v("还在路上，我们就不废话了。")]),t._v(" "),a("p",[a("img",{attrs:{src:"https://static.pity.fun/picture/2021-8-21/1629561311267-image.png",alt:""}})])])}),[],!1,null,null,null);a.default=_.exports}}]);