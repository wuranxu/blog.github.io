(window.webpackJsonp=window.webpackJsonp||[]).push([[161],{572:function(s,t,a){"use strict";a.r(t);var r=a(2),e=Object(r.a)({},(function(){var s=this,t=s._self._c;return t("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[t("blockquote",[t("p",[s._v("大家好~我是"),t("code",[s._v("米洛")]),s._v("！"),t("br"),t("br"),s._v("\n这是一个完整的"),t("code",[s._v("接口测试平台系列教程")]),s._v("，希望能和大家一起学习，从0到1打造一个开源平台。"),t("br"),s._v(" "),t("br"),s._v("\n欢迎关注我的公众号"),t("code",[s._v("米洛的测开日记")]),s._v("，获取最新文章教程!")])]),s._v(" "),t("h3",{attrs:{id:"回顾"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#回顾"}},[s._v("#")]),s._v(" 回顾")]),s._v(" "),t("p",[s._v("上一节我们编写了"),t("code",[s._v("用例列表")]),s._v("相关改造，但由于编辑/新增case的页面还得好好设计一番，而"),t("code",[s._v("后端接口")]),s._v("也没啥大的变化。")]),s._v(" "),t("p",[s._v("所以今天我们来聊聊怎么部署。")]),s._v(" "),t("h3",{attrs:{id:"部署服务的几种方式"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#部署服务的几种方式"}},[s._v("#")]),s._v(" 部署服务的几种方式")]),s._v(" "),t("p",[s._v("其实我们如果是在"),t("code",[s._v("公司")]),s._v("使用的话，一般公司运维都会提供部署服务的平台，但可能都是以业务代码使用的语言为主。")]),s._v(" "),t("p",[s._v("比如我上家公司，"),t("code",[s._v("业务代码")]),s._v("是用的Java，所以在Java服务的部署上，基本上接入公司发布系统即可。不扯远了，有的公司测试会自己维护一台服务器，随便儿你玩，不走发布系统。（当然如果你们公司支持Python服务的发布，建议还是用公司的发布系统，贵在稳定+可视化）")]),s._v(" "),t("p",[s._v("如果我们是自己维护自己的服务器，该怎么"),t("code",[s._v("部署咱们的系统")]),s._v("呢？")]),s._v(" "),t("p",[s._v("以下是Pity的"),t("code",[s._v("部署教程")]),s._v("，如果想看其他Python部署方式的，可以先跳过哈。")]),s._v(" "),t("h3",{attrs:{id:"数据库"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#数据库"}},[s._v("#")]),s._v(" 数据库")]),s._v(" "),t("p",[s._v("数据库这块比较简单，Pity提供了自动建表功能，底层使用的是"),t("code",[s._v("MySQL")]),s._v("，所以大家需要准备一台MySQL服务器，或者就在你的服务器安装好MySQL也是一样。")]),s._v(" "),t("p",[t("code",[s._v("具体的安装过程我这儿就不细说了。")])]),s._v(" "),t("p",[s._v("安装好以后我们会拿到用户名，密码，host和port信息，我们还需要创建数据库:")]),s._v(" "),t("div",{staticClass:"language-SHELL line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[s._v("create database pity"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("h2",{attrs:{id:"修改pity关于数据库的配置"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#修改pity关于数据库的配置"}},[s._v("#")]),s._v(" 修改pity关于数据库的配置")]),s._v(" "),t("p",[s._v("在pity/Config.py修改SQLALCHEMY的连接串:")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://static.pity.fun/picture/2021-8-29/1630218030208-image.png",alt:"配置成你们本地的数据库连接"}})]),s._v(" "),t("p",[s._v("这样你的数据就能好好保存在你们的"),t("code",[s._v("数据库")]),s._v("了。")]),s._v(" "),t("h3",{attrs:{id:"安装依赖"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#安装依赖"}},[s._v("#")]),s._v(" 安装依赖")]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[s._v("pip3 "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("install")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-r")]),s._v(" requirements.txt\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("p",[s._v("也可以使用豆瓣源:")]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[s._v("pip3 "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("install")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-r")]),s._v(" requirements.txt "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-i")]),s._v(" https://pypi.douban.com/simple\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("p",[s._v("如果过程中安装失败了，建议"),t("code",[s._v("升级一下pip")]),s._v("。")]),s._v(" "),t("h3",{attrs:{id:"测试服务是否启动"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#测试服务是否启动"}},[s._v("#")]),s._v(" 测试服务是否启动")]),s._v(" "),t("p",[s._v("如果启动服务的时候报没有logs文件夹，可以在pity根目录新建文件夹: "),t("code",[s._v("logs")]),s._v("，因为github会自动忽略掉空文件夹，所以可能需要大家自己创建。")]),s._v(" "),t("p",[s._v("在pity目录下启动服务:")]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[s._v("python3 main.py\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("p",[t("img",{attrs:{src:"https://static.pity.fun/picture/2021-8-29/1630218246255-image.png",alt:"如果出现这样的图片，则是启动成功了"}})]),s._v(" "),t("p",[s._v("打开"),t("code",[s._v("http://服务器ip:7777")]),s._v(":")]),s._v(" "),t("h2",{attrs:{id:""}},[t("a",{staticClass:"header-anchor",attrs:{href:"#"}},[s._v("#")]),s._v(" "),t("img",{attrs:{src:"https://static.pity.fun/picture/2021-8-29/1630218498240-image.png",alt:""}})]),s._v(" "),t("h3",{attrs:{id:"正题"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#正题"}},[s._v("#")]),s._v(" 正题")]),s._v(" "),t("p",[s._v("我们今天主要是讲怎么用gunicorn部署Python服务，只不过博主我先用了自己的项目"),t("code",[s._v("探路")]),s._v("。")]),s._v(" "),t("p",[s._v("回到正题，我们先来看一看最简单的一个"),t("code",[s._v("部署方式")]),s._v("。")]),s._v(" "),t("h2",{attrs:{id:"经典部署方式"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#经典部署方式"}},[s._v("#")]),s._v(" 经典部署方式")]),s._v(" "),t("p",[s._v("在解决好所有环境依赖以后，我们通过python3 xxx.py启动服务，这样其他人就能够通过服务器ip+端口访问页面了。")]),s._v(" "),t("p",[t("code",[s._v("http://服务器ip:端口号/")])]),s._v(" "),t("p",[s._v("思考一下这样做的弊端:")]),s._v(" "),t("ol",[t("li",[s._v("服务器会一直打印着请求信息，并没有在后台运行")])]),s._v(" "),t("p",[t("img",{attrs:{src:"https://static.pity.fun/picture/2021-8-29/1630219827637-image.png",alt:"就像现在这样，shell会一直持续保持这样的状态"}})]),s._v(" "),t("ol",{attrs:{start:"2"}},[t("li",[s._v("程序如果自动宕机，不能自动恢复")])]),s._v(" "),t("p",[s._v("比如哪天程序不小心崩溃了，有的异常没有被"),t("code",[s._v("自动捕获")]),s._v("，导致整个Python程序崩溃，从而导致"),t("code",[s._v("系统无法访问")]),s._v("。")]),s._v(" "),t("ol",{attrs:{start:"3"}},[t("li",[s._v("Python GIL性能太差")])]),s._v(" "),t("h2",{attrs:{id:"改进一下"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#改进一下"}},[s._v("#")]),s._v(" 改进一下")]),s._v(" "),t("p",[s._v("针对经典部署，其实也有一些处理方式，比如第一条，我们可以用"),t("code",[s._v("nohup")]),s._v("帮我们解决第一个困难。")]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[t("span",{pre:!0,attrs:{class:"token function"}},[s._v("nohup")]),s._v(" python xxx.py "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("p",[s._v("然后可以看到"),t("code",[s._v("当前目录")]),s._v("生成了nohup.out的文件，而你的控制台窗口也没有再"),t("code",[s._v("停留")]),s._v("在服务输出窗口。")]),s._v(" "),t("p",[s._v("但还有其他困难，我们怎么解决呢？别慌！我们还有gunicorn+supervisor")]),s._v(" "),t("h3",{attrs:{id:"supervisor"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#supervisor"}},[s._v("#")]),s._v(" supervisor")]),s._v(" "),t("p",[s._v("supervisor是一个托管容器，你的应用会被托管到里面，而他会提供一个"),t("code",[s._v("守护线程")]),s._v("，专门监控你的应用。当你的应用不小心崩了，他会自动把应用拉起，"),t("code",[s._v("非常好用")]),s._v("！")]),s._v(" "),t("p",[s._v("遇到非代码错误，比如有人误操作kill掉你的程序，它会自动帮忙拉起，毫无波澜。")]),s._v(" "),t("h3",{attrs:{id:"gunicorn"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#gunicorn"}},[s._v("#")]),s._v(" gunicorn")]),s._v(" "),t("p",[s._v("gunicorn基于gevent，差不多算是个提升app性能的库，它可以帮助我们的web应用提升性能，并且他也有自动重启的功能，还可以开启根据服务器配置开启不同数量的"),t("code",[s._v("worker")]),s._v("。")]),s._v(" "),t("h3",{attrs:{id:"怎么使用呢"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#怎么使用呢"}},[s._v("#")]),s._v(" 怎么使用呢")]),s._v(" "),t("h2",{attrs:{id:"安装gunicorn"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#安装gunicorn"}},[s._v("#")]),s._v(" 安装Gunicorn")]),s._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("pip3 install gunicorn\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("p",[s._v("以我们的app为例，我们的app名字叫pity，文件是main.py，所以取到app的方法就是: main:pity")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://static.pity.fun/picture/2021-8-29/1630223614857-image.png",alt:""}})]),s._v(" "),t("h2",{attrs:{id:"普通gunicorn模式"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#普通gunicorn模式"}},[s._v("#")]),s._v(" 普通gunicorn模式")]),s._v(" "),t("p",[s._v("安装好以后gunicorn命令就能够使用了，输入命令:")]),s._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("# FastApi应用\ngunicorn -k uvicorn.workers.UvicornWorker main:pity -b 0.0.0.0:7777 -w 4 &\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br")])]),t("p",[s._v("解释一下参数:")]),s._v(" "),t("h5",{attrs:{id:"k"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#k"}},[s._v("#")]),s._v(" -k:")]),s._v(" "),t("p",[s._v("这个是指定worker为Uvicorn的Worker，为fastapi专属，其他比如flask应用不需要带上这个参数。")]),s._v(" "),t("h5",{attrs:{id:"w"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#w"}},[s._v("#")]),s._v(" -w")]),s._v(" "),t("p",[s._v("workers数量，也就是起的线程数量，一般根据自己"),t("code",[s._v("CPU内核")]),s._v("来。比如我的服务器是4核的，那我就设定为4。")]),s._v(" "),t("p",[s._v("main:pity就是上面说的app的具体位置。")]),s._v(" "),t("h3",{attrs:{id:"试验一下"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#试验一下"}},[s._v("#")]),s._v(" 试验一下")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://static.pity.fun/picture/2021-8-29/1630223969958-image.png",alt:"可以看到服务都启动成功了"}})]),s._v(" "),t("p",[t("img",{attrs:{src:"https://static.pity.fun/picture/2021-8-29/1630224043402-image.png",alt:"ps -ef | grep gunicorn可以看到这些个线程"}})]),s._v(" "),t("h2",{attrs:{id:"配置文件的方式启动"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#配置文件的方式启动"}},[s._v("#")]),s._v(" 配置文件的方式启动")]),s._v(" "),t("p",[s._v("我们编写gunicorn.py文件（配置文件）:")]),s._v(" "),t("div",{staticClass:"language-Python line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-python"}},[t("code",[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("import")]),s._v(" os\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("import")]),s._v(" gevent"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("monkey\n\ngevent"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("monkey"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("patch_all"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("import")]),s._v(" multiprocessing\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# debug = True")]),s._v("\nloglevel "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'debug'")]),s._v("\nbind "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"0.0.0.0:7777"')]),s._v("\npidfile "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"logs/gunicorn.pid"')]),s._v("\naccesslog "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"logs/access.log"')]),s._v("\nerrorlog "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"logs/debug.log"')]),s._v("\ndaemon "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("True")]),s._v("\ntimeout "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("60")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 启动的进程数")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# workers = multiprocessing.cpu_count()")]),s._v("\nworkers "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("8")]),s._v("\nworker_class "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'gevent'")]),s._v("\nx_forwarded_for_header "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'X-FORWARDED-FOR'")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br"),t("span",{staticClass:"line-number"},[s._v("18")]),t("br"),t("span",{staticClass:"line-number"},[s._v("19")]),t("br"),t("span",{staticClass:"line-number"},[s._v("20")]),t("br"),t("span",{staticClass:"line-number"},[s._v("21")]),t("br")])]),t("p",[s._v("配置好bind地址，日志信息，workders数量，"),t("code",[s._v("multiprocessing.cpu_count()")]),s._v("会返回CPU数量。")]),s._v(" "),t("p",[t("code",[s._v("记得安装gevent")]),s._v("，用pip。")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://static.pity.fun/picture/2021-8-29/1630224391332-image.png",alt:""}})]),s._v(" "),t("p",[s._v("可以看到服务起来了，这边我开了8个"),t("code",[s._v("workder")]),s._v("。")]),s._v(" "),t("p",[s._v("其实这个时候gunicorn已经具备了"),t("code",[s._v("自动拉起")]),s._v("功能，但gunicorn也可能被kill掉，所以我们更稳妥点儿的话，需要"),t("code",[s._v("supervisor")]),s._v("。")]),s._v(" "),t("h2",{attrs:{id:"supervisor-2"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#supervisor-2"}},[s._v("#")]),s._v(" supervisor")]),s._v(" "),t("p",[s._v("这块的资料比较多，大家可以尽情百度，因为博主主要讲的是部署方式，还得靠大家自己去"),t("code",[s._v("实践")]),s._v("呐。")]),s._v(" "),t("h3",{attrs:{id:"更多部署方式"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#更多部署方式"}},[s._v("#")]),s._v(" 更多部署方式")]),s._v(" "),t("p",[t("code",[s._v("docker")]),s._v("，"),t("code",[s._v("k8s")]),s._v("什么的也是不错的选择，如果大家有兴趣也可以多研究一下，作为"),t("code",[s._v("测试")]),s._v("的我们，掌握好基本的用法即可。")]),s._v(" "),t("p",[s._v("如果有兴趣也欢迎大家一起"),t("code",[s._v("探讨")]),s._v("~~")])])}),[],!1,null,null,null);t.default=e.exports}}]);