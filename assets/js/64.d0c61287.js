(window.webpackJsonp=window.webpackJsonp||[]).push([[64],{474:function(t,s,a){"use strict";a.r(s);var n=a(2),r=Object(n.a)({},(function(){var t=this,s=t._self._c;return s("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[s("blockquote",[s("p",[t._v("大家好~我是"),s("code",[t._v("米洛")]),t._v("！"),s("br"),t._v("\n我正在从0到1打造一个开源的接口测试平台, 也在编写一套与之对应的"),s("code",[t._v("教程")]),t._v("，希望大家多多支持。"),s("br"),t._v("\n欢迎关注我的公众号"),s("code",[t._v("米洛的测开日记")]),t._v("，获取最新文章教程!")])]),t._v(" "),s("h3",{attrs:{id:"回顾"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#回顾"}},[t._v("#")]),t._v(" 回顾")]),t._v(" "),s("p",[t._v("上一节我们编写了"),s("code",[t._v("日志模块")]),t._v("相关的改造，这一节我们继续趁热打铁，来继续丰富我们的系统。")]),t._v(" "),s("h3",{attrs:{id:"配置的问题"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#配置的问题"}},[t._v("#")]),t._v(" 配置的问题")]),t._v(" "),s("p",[t._v("我们目前系统的配置算是一个很"),s("code",[t._v("简陋")]),t._v("的版本，由于我习惯了在"),s("code",[t._v("生产环境")]),t._v("(这里指的是pity的生产环境)进行开发，所以很多时候我的配置直接就写死为pity的生产配置。")]),t._v(" "),s("p",[t._v("但这显然很"),s("code",[t._v("不合理")]),t._v("，因为以规范的开发模式来说，我们如果是测试环境或者开发环境，我们一般会连接dev的数据库/redis等中间件。")]),t._v(" "),s("p",[t._v("这样我们才能做到，在进行"),s("code",[t._v("新功能")]),t._v("开发的同时，不影响到线上的数据。")]),t._v(" "),s("h4",{attrs:{id:"举个例子"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#举个例子"}},[t._v("#")]),t._v(" 举个例子")]),t._v(" "),s("p",[t._v("我现在用户表要修改一个字段的类型，从varchar改为integer。此时注意我们线上的代码依旧是以varchar的形式运行的。")]),t._v(" "),s("p",[t._v("如果我们本地测试的时候改掉了字段，那线上的代码运行到那块的时候就会出现"),s("code",[t._v("类型不匹配")]),t._v("的问题了。目前pity还没啥人在使用，如果大家已经开始在自己公司使用了，那新功能开发的同时就会影响到已有的代码。")]),t._v(" "),s("h3",{attrs:{id:"解决方案"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#解决方案"}},[t._v("#")]),t._v(" 解决方案")]),t._v(" "),s("p",[t._v("其实这块解决方案，我见过的公司都是采用"),s("code",[t._v("环境变量")]),t._v("的方式来解决的。比如服务启动的时候，会自动去"),s("code",[t._v("系统变量")]),t._v("获取某一个特定的变量值，举个例子叫: "),s("code",[t._v("pity_env")]),t._v("。")]),t._v(" "),s("p",[t._v("如果这个值为"),s("code",[t._v("DEV")]),t._v("，则使用"),s("code",[t._v("DEV")]),t._v("的配置数据，如果是其他环境，则用"),s("code",[t._v("其他环境")]),t._v("的配置。所以解决起来相对还是比较简单的。")]),t._v(" "),s("p",[t._v("不过要注意到，我们的configuration.json也要区分环境哦，没关系，我们一起改造就可以了！")]),t._v(" "),s("h3",{attrs:{id:"行动起来"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#行动起来"}},[t._v("#")]),t._v(" 行动起来")]),t._v(" "),s("p",[t._v("首先第一步我们要确认一下我们到底有多少环境，复杂点的话，可能需要DEV/UAT/PRO等多种环境，毕竟我们的代码也需要测试，跟着开发的节奏走。不过这里我就不"),s("code",[t._v("搞那么多环境")]),t._v("了，我们只分DEV和PRO环境即可。")]),t._v(" "),s("ul",[s("li",[s("p",[t._v("修改config.py")]),t._v(" "),s("p",[t._v("我们只需要写个"),s("code",[t._v("基础配置类")]),t._v("，接着不同的Config继承之即可。所以我们拆出公共变量:")])])]),t._v(" "),s("p",[s("img",{attrs:{src:"https://static.pity.fun/picture/2022-2-7/1644239279003-image.png",alt:""}})]),t._v(" "),s("p",[s("img",{attrs:{src:"https://static.pity.fun/picture/2022-2-7/1644239311869-image.png",alt:""}})]),t._v(" "),s("p",[t._v("接着分开给出DevConfig和ProConfig，最后做一个判断:")]),t._v(" "),s("div",{staticClass:"language-python line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-python"}},[s("code",[s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 获取pity环境变量")]),t._v("\nPITY_ENV "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" os"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("environ"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("get"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"pity_env"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 如果pity_env存在且为prod")]),t._v("\nConfig "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" ProConfig"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" PITY_ENV "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("and")]),t._v(" PITY_ENV"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("lower"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("==")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"pro"')]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("else")]),t._v(" DevConfig"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br"),s("span",{staticClass:"line-number"},[t._v("2")]),s("br"),s("span",{staticClass:"line-number"},[t._v("3")]),s("br"),s("span",{staticClass:"line-number"},[t._v("4")]),s("br")])]),s("p",[t._v("先获取pity_env的值，如果有且为pro，则是生产环境，否则则是pro环境。")]),t._v(" "),s("p",[t._v("这样也有一定的风险，即开发其实可以本地改成pro环境，但在企业里面pro环境和其他环境一般是隔离了的，所以就算你配置成Pro的环境，也访问不到pro的数据库等（相对来说会严谨很多，所以这么做也没啥毛病，大胆放心去用吧！）")]),t._v(" "),s("p",[t._v("为了不影响之前的代码，我们特意"),s("code",[t._v("创建了")]),t._v("一个Config变量，和之前保持一致。")]),t._v(" "),s("h3",{attrs:{id:"改造configuration相关内容"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#改造configuration相关内容"}},[t._v("#")]),t._v(" 改造configuration相关内容")]),t._v(" "),s("ol",[s("li",[t._v("我们把现有的configuration.json改为configuration_dev.json并复制一份，命名为configuration_pro.json。")]),t._v(" "),s("li",[t._v("编写获取文件名的方法")]),t._v(" "),s("li",[t._v("调整获取和update相关方法")])]),t._v(" "),s("p",[s("img",{attrs:{src:"https://static.pity.fun/picture/2022-2-7/1644240388694-image.png",alt:""}})]),t._v(" "),s("h3",{attrs:{id:"测试一下"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#测试一下"}},[t._v("#")]),t._v(" 测试一下")]),t._v(" "),s("p",[t._v("为了更帅气一点，我们可以加上之前学过的banner和当前环境标识，以日志的形式打印出来。先看看最终效果:")]),t._v(" "),s("p",[s("img",{attrs:{src:"https://static.pity.fun/picture/2022-2-7/1644242896138-image.png",alt:""}})]),t._v(" "),s("ul",[s("li",[t._v("添加环境变量")])]),t._v(" "),s("p",[s("img",{attrs:{src:"https://static.pity.fun/picture/2022-2-7/1644242323183-image.png",alt:""}})]),t._v(" "),s("ul",[s("li",[s("p",[t._v("在初始化日志之后打印相关banner提示")]),t._v(" "),s("p",[t._v("在main.py初始化logger后加入以下语句:")])])]),t._v(" "),s("div",{staticClass:"language-python line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-python"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("from")]),t._v(" config "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" BANNER\n\nlogger"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("bind"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("name"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("None")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("opt"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("ansi"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("True")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("info"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string-interpolation"}},[s("span",{pre:!0,attrs:{class:"token string"}},[t._v('f"pity is running at <red>')]),s("span",{pre:!0,attrs:{class:"token interpolation"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("PITY_ENV"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")])]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('</red>"')])]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\nlogger"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("bind"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("name"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("None")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("info"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("BANNER"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br"),s("span",{staticClass:"line-number"},[t._v("2")]),s("br"),s("span",{staticClass:"line-number"},[t._v("3")]),s("br"),s("span",{staticClass:"line-number"},[t._v("4")]),s("br")])]),s("ul",[s("li",[t._v("在config.py底部写入banner")])]),t._v(" "),s("div",{staticClass:"language-python line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-python"}},[s("code",[t._v("BANNER "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token triple-quoted-string string"}},[t._v('"""\n ________        ___          _________         ___    ___ \n|\\   __  \\      |\\  \\        |\\___   ___\\      |\\  \\  /  /|\n\\ \\  \\|\\  \\     \\ \\  \\       \\|___ \\  \\_|      \\ \\  \\/  / /\n \\ \\   ____\\     \\ \\  \\           \\ \\  \\        \\ \\    / / \n  \\ \\  \\___|      \\ \\  \\           \\ \\  \\        \\/  /  /  \n   \\ \\__\\          \\ \\__\\           \\ \\__\\     __/  / /    \n    \\|__|           \\|__|            \\|__|    |\\___/ /     \n                                              \\|___|/      \n\n"""')]),t._v("\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br"),s("span",{staticClass:"line-number"},[t._v("2")]),s("br"),s("span",{staticClass:"line-number"},[t._v("3")]),s("br"),s("span",{staticClass:"line-number"},[t._v("4")]),s("br"),s("span",{staticClass:"line-number"},[t._v("5")]),s("br"),s("span",{staticClass:"line-number"},[t._v("6")]),s("br"),s("span",{staticClass:"line-number"},[t._v("7")]),s("br"),s("span",{staticClass:"line-number"},[t._v("8")]),s("br"),s("span",{staticClass:"line-number"},[t._v("9")]),s("br"),s("span",{staticClass:"line-number"},[t._v("10")]),s("br"),s("span",{staticClass:"line-number"},[t._v("11")]),s("br")])]),s("h2",{attrs:{id:"从效果图可以看出-我们打印出了当前的环境-超赛神pro。"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#从效果图可以看出-我们打印出了当前的环境-超赛神pro。"}},[t._v("#")]),t._v(" 从效果图可以看出，我们打印出了当前的环境, 超赛神pro。")]),t._v(" "),s("p",[t._v("今天的内容就分享到这里，大家也可以试试给自己的项目加点帅气的"),s("code",[t._v("banner")]),t._v(".")])])}),[],!1,null,null,null);s.default=r.exports}}]);