(window.webpackJsonp=window.webpackJsonp||[]).push([[152],{561:function(t,v,_){"use strict";_.r(v);var s=_(2),a=Object(s.a)({},(function(){var t=this,v=t._self._c;return v("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[v("blockquote",[v("p",[t._v("大家好~我是"),v("code",[t._v("米洛")]),t._v("！"),v("br"),v("br"),t._v("\n我在从0到1打造一个开源平台, 也在编写一套完整的"),v("code",[t._v("接口测试平台系列教程")]),t._v("，希望大家能够多多支持。"),v("br"),t._v(" "),v("br"),t._v("\n欢迎关注我的公众号"),v("code",[t._v("米洛的测开日记")]),t._v("，获取最新文章教程!")])]),t._v(" "),v("h3",{attrs:{id:"回顾"}},[v("a",{staticClass:"header-anchor",attrs:{href:"#回顾"}},[t._v("#")]),t._v(" 回顾")]),t._v(" "),v("p",[t._v("上一节我们边写了"),v("code",[t._v("数据库配置")]),t._v("的功能接口，但是前端页面还没有做展示。")]),t._v(" "),v("p",[t._v("如果完成了前端页面增删改查页面，我想我们还需要几个功能:")]),t._v(" "),v("ul",[v("li",[v("p",[t._v("在线测试连接")]),t._v(" "),v("p",[t._v("因为有的时候"),v("code",[t._v("数据库配置")]),t._v("会发生变化，如果我们不支持在线测试功能的话，可能大家还需要手动去连接一下，"),v("code",[t._v("非常难用")]),t._v("！")])]),t._v(" "),v("li",[v("p",[t._v("在线执行SQL")]),t._v(" "),v("p",[t._v("这个是为了能够给"),v("code",[t._v("用户")]),t._v("在线运行sql语句，类似于小ide的功能，当然我们只做最核心的部分。")]),t._v(" "),v("p",[t._v("那么今天我们就来完善前端页面并"),v("code",[t._v("完成在线连接测试功能")]),t._v("。")])])]),t._v(" "),v("h3",{attrs:{id:"前端部分"}},[v("a",{staticClass:"header-anchor",attrs:{href:"#前端部分"}},[t._v("#")]),t._v(" 前端部分")]),t._v(" "),v("p",[t._v("前端部分还是以往的"),v("code",[t._v("dispatch")]),t._v("模式，service.js用于发送http请求，model用于管理变量，组件通过dispatch去调用具体的方法。")]),t._v(" "),v("p",[v("img",{attrs:{src:"https://static.pity.fun/picture/2021-8-21/1629524506213-image.png",alt:""}})]),t._v(" "),v("p",[t._v("前端页面还是分3个部分，可以理解为3个div:")]),t._v(" "),v("ul",[v("li",[t._v("搜索栏")]),t._v(" "),v("li",[t._v("添加栏")]),t._v(" "),v("li",[t._v("表格栏")])]),t._v(" "),v("p",[v("img",{attrs:{src:"https://static.pity.fun/picture/2021-8-21/1629524586062-image.png",alt:"这是需要填写的表单"}})]),t._v(" "),v("p",[t._v("大概的页面展示是这样，我们今天重点讲一下数据库连接这块。")]),t._v(" "),v("h3",{attrs:{id:"思考怎么做"}},[v("a",{staticClass:"header-anchor",attrs:{href:"#思考怎么做"}},[t._v("#")]),t._v(" 思考怎么做")]),t._v(" "),v("p",[t._v("连接部分我们仍然打算采用"),v("code",[t._v("sqlalchemy")]),t._v("，既然已经开始用了，而且他也支持异步session，在"),v("code",[t._v("没遇到大坑")]),t._v("的时候我们就不考虑更换了。")]),t._v(" "),v("p",[t._v("首先我们考虑以下几个点:")]),t._v(" "),v("h2",{attrs:{id:"连接复用"}},[v("a",{staticClass:"header-anchor",attrs:{href:"#连接复用"}},[t._v("#")]),t._v(" 连接复用")]),t._v(" "),v("p",[t._v("首先要清楚，我们之所以做数据库连接配置，是因为我们在"),v("code",[t._v("构造数据")]),t._v("的时候会用到，那么我们势必要维护一个数据库连接的map，充当缓存的作用。")]),t._v(" "),v("p",[t._v("当我们的账号密码等连接信息没有变化的时候，我们是不是可以把"),v("code",[t._v("上次连接用的session")]),t._v("拿出来继续使用？答案是肯定的！")]),t._v(" "),v("p",[t._v("而且当我们测试连接以后，这个数据库配置就被缓存了起来，如果我们要使用，直接从连接缓存里面拿就可以了。配合sqlalchemy本身自带的连接池，基本上我们要做的就比较简单，只是包一层dict即可。")]),t._v(" "),v("h2",{attrs:{id:"缓存扩张问题"}},[v("a",{staticClass:"header-anchor",attrs:{href:"#缓存扩张问题"}},[t._v("#")]),t._v(" 缓存扩张问题")]),t._v(" "),v("p",[t._v("举个例子，我现在配置了A数据库连接，测试了一遍，你给我缓存起来了，接着我把A改成B，由于"),v("code",[t._v("A和B的配置不一样")]),t._v("，所以缓存里面现在需要插入一条B数据，如果改的频繁，就会使得这个dict无限扩张，内存也会占用变大。但因为数据库配置不太可能经常变化，我们也可以在update配置的时候清楚之前的缓存。")]),t._v(" "),v("h2",{attrs:{id:"多线程访问缓存的问题"}},[v("a",{staticClass:"header-anchor",attrs:{href:"#多线程访问缓存的问题"}},[t._v("#")]),t._v(" 多线程访问缓存的问题")]),t._v(" "),v("p",[t._v("Python的多线程我不是"),v("code",[t._v("太熟悉")]),t._v("，不太确定Fastapi内部是否会有多个线程同时读写缓存的情况，如果有，那肯定会出问题的，我们需要加🔒，暂时我们可以先"),v("code",[t._v("观望一下")]),t._v("。")]),t._v(" "),v("h3",{attrs:{id:"动起手来"}},[v("a",{staticClass:"header-anchor",attrs:{href:"#动起手来"}},[t._v("#")]),t._v(" 动起手来")]),t._v(" "),v("p",[t._v("我们对之前的models/"),v("strong",[t._v("init")]),t._v(".py方法进行一些改造，我们需要增加一个DatabaseHelper类。")]),t._v(" "),v("p",[v("img",{attrs:{src:"https://static.pity.fun/picture/2021-8-21/1629525846035-image.png",alt:"为什么要传入这么多参数，是因为传入配置id的话，需要再次查询数据库，比较麻烦"}})]),t._v(" "),v("ul",[v("li",[v("p",[t._v("init方法")]),t._v(" "),v("p",[t._v("init方法创建了我们内部的dict缓存，key是数据库的连接信息，value是对应的session。")])]),t._v(" "),v("li",[v("p",[t._v("get_connection")]),t._v(" "),v("p",[t._v("通过数据库配置去获取到对应的连接信息，首先拼接key，拿到唯一的key标识，接着去缓存找有没有初始化这个连接，有的话直接返回，没有就开始建立连接。")])]),t._v(" "),v("li",[v("p",[t._v("get_jdbc_url")])])]),t._v(" "),v("p",[v("img",{attrs:{src:"https://static.pity.fun/picture/2021-8-21/1629526329143-image.png",alt:"这里其实是把数据库配置转为了数据库连接url"}})]),t._v(" "),v("p",[t._v("注意: "),v("code",[t._v("pg我还没有找到合适的异步库，所以暂时先不支持它，后面再支持，总感觉pg用的人并没有那么多。")])]),t._v(" "),v("ul",[v("li",[t._v("删除缓存的方法")])]),t._v(" "),v("p",[v("img",{attrs:{src:"https://static.pity.fun/picture/2021-8-21/1629527140291-image.png",alt:"先判断是否有该key，有则删除"}})]),t._v(" "),v("ul",[v("li",[t._v("测试连接的方法")])]),t._v(" "),v("p",[v("img",{attrs:{src:"https://static.pity.fun/picture/2021-8-21/1629526767841-image.png",alt:""}})]),t._v(" "),v("p",[t._v("接受一个session，如果为空，则返回错误信息。最后execute一句"),v("code",[t._v("select 1")]),t._v("测试是否能够正常连上数据库，不能则返回错误信息。")]),t._v(" "),v("p",[v("img",{attrs:{src:"https://static.pity.fun/picture/2021-8-21/1629526418494-image.png",alt:"最后我们再实例化这个Helper，统一调用这个对象即可"}})]),t._v(" "),v("ul",[v("li",[t._v("改写update方法")])]),t._v(" "),v("p",[v("img",{attrs:{src:"https://static.pity.fun/picture/2021-8-21/1629526869625-image.png",alt:"加入删除缓存的部分"}})]),t._v(" "),v("ul",[v("li",[t._v("编写在线测试方法")])]),t._v(" "),v("p",[v("img",{attrs:{src:"https://static.pity.fun/picture/2021-8-21/1629526913611-image.png",alt:"如果session没获取到，返回错误信息"}})]),t._v(" "),v("h3",{attrs:{id:"测试一哈"}},[v("a",{staticClass:"header-anchor",attrs:{href:"#测试一哈"}},[t._v("#")]),t._v(" 测试一哈")]),t._v(" "),v("p",[v("img",{attrs:{src:"https://static.pity.fun/picture/2021-8-21/1629526965450-image.png",alt:"密码不正确的时候"}})]),t._v(" "),v("p",[v("img",{attrs:{src:"https://static.pity.fun/picture/2021-8-21/1629527032019-image.png",alt:"这是密码正确的情况下"}})]),t._v(" "),v("p",[t._v("今天的内容到这里就结束了，下一节我们编写在线执行"),v("code",[t._v("SQL")]),t._v("功能。")])])}),[],!1,null,null,null);v.default=a.exports}}]);