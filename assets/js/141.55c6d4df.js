(window.webpackJsonp=window.webpackJsonp||[]).push([[141],{557:function(t,s,a){"use strict";a.r(s);var e=a(2),n=Object(e.a)({},(function(){var t=this,s=t._self._c;return s("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[s("blockquote",[s("p",[t._v("大家好，我是米洛，求三连！求关注"),s("code",[t._v("米洛的测开日记")]),t._v("!")])]),t._v(" "),s("p",[t._v("如果阅读完毕后想和作者有更多交流，可以点击"),s("code",[t._v("阅读原文")]),t._v("找到底部评论区，给作者留言啦！")]),t._v(" "),s("h3",{attrs:{id:"回顾"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#回顾"}},[t._v("#")]),t._v(" 回顾")]),t._v(" "),s("p",[t._v("前一章我们把http换成了aiohttp，完成了"),s("code",[t._v("数据构造器")]),t._v("功能。今天就轻松点吧~")]),t._v(" "),s("h3",{attrs:{id:"用例运行"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#用例运行"}},[t._v("#")]),t._v(" 用例运行")]),t._v(" "),s("p",[t._v("目前我们开放了api，"),s("code",[t._v("/request/run")]),t._v("这个接口去运行单个"),s("code",[t._v("用例")]),t._v("。但是我们的目标并不是"),s("code",[t._v("做一个玩具")]),t._v("，所以我们需要想一下怎么去支持多条用例一起执行。")]),t._v(" "),s("p",[t._v("至于测试集，测试计划，定时任务这种也会陆续展开，先把眼前的"),s("code",[t._v("困难")]),t._v("给解决。")]),t._v(" "),s("p",[t._v("所以我们需要在页面上可以"),s("code",[t._v("多选")]),t._v("用例来执行，并能看到一个具体的报告，有了这一步，后续整合测试集和测试计划就易如反掌了。")]),t._v(" "),s("h3",{attrs:{id:"mq-celery"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#mq-celery"}},[t._v("#")]),t._v(" MQ/celery？")]),t._v(" "),s("p",[t._v("其实是可以用mq的方式去执行用例，用户选定了一批用例，直接往mq里面塞就"),s("code",[t._v("完事")]),t._v("了，剩下的交给消费者。")]),t._v(" "),s("p",[t._v("这样的好处就是耦合度大大降低，我们的后端服务和消费者是完全分开的，就算要这么玩，消费者也不会用"),s("code",[t._v("Python")]),t._v("来做。这样我们在后端服务上线的时候不会影响到"),s("code",[t._v("执行结果")]),t._v("。")]),t._v(" "),s("p",[t._v("不过这么做其实增加了我们系统的复杂度，这是我不想要的。")]),t._v(" "),s("p",[t._v("我们还是先观察下Python批量执行case的效率吧！")]),t._v(" "),s("h3",{attrs:{id:"普通方式"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#普通方式"}},[t._v("#")]),t._v(" 普通方式")]),t._v(" "),s("p",[t._v("先编写一个"),s("code",[t._v("同步版本")]),t._v("的批量运行方法。")]),t._v(" "),s("p",[s("img",{attrs:{src:"https://static.pity.fun/picture/2021-8-8/1628417663105-image.png",alt:""}})]),t._v(" "),s("p",[t._v("由于我的"),s("code",[t._v("run")]),t._v("方法已经被改造为异步方法了，所以这边写法是这么写，但其实还是"),s("code",[t._v("同步")]),t._v("的执行过程。")]),t._v(" "),s("p",[t._v("代码很简单，我们通过"),s("code",[t._v("循环")]),t._v("执行每个case，然后把结果写到data字典里面，最后输出具体的"),s("code",[t._v("耗时")]),t._v("（只是测试用）。")]),t._v(" "),s("p",[s("img",{attrs:{src:"https://static.pity.fun/picture/2021-8-8/1628418311811-image.png",alt:""}})]),t._v(" "),s("p",[t._v("可以看到，在本地数据库+我的高配置机器加持下还是需要30多秒执行100来个用例。其实"),s("code",[t._v("已经能够接受")]),t._v("了，但是后续数量更大的话，怎么办！咱们直接一步到位，开始改造。")]),t._v(" "),s("h3",{attrs:{id:"不只是http有异步库"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#不只是http有异步库"}},[t._v("#")]),t._v(" 不只是http有异步库")]),t._v(" "),s("p",[t._v("其实mysql也有个异步库: aiomysql，所以我们需要先安装依赖:")]),t._v(" "),s("div",{staticClass:"language-shell line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-shell"}},[s("code",[t._v("pip3 "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("install")]),t._v(" aiomysql\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br")])]),s("p",[t._v("这个库可以嵌入到sqlalchemy，因为sqlalchemy1.4以上已经支持了asyncio（我个人认为这是一个大的趋势，"),s("code",[t._v("能快为啥要慢")]),t._v("呢？如果Python有很快的速度+极高的开发效率，不说大型业务服务，起码测试平台的市场是可以拿捏的四死的！）")]),t._v(" "),s("p",[t._v("可能因为我最近Java写的比较多，处理嵌套很深的JSON，需要定义各种class，要不就是各种转换类型，难受啊。")]),t._v(" "),s("ul",[s("li",[t._v("config.py新增异步SQLALCHEMY_URI")])]),t._v(" "),s("div",{staticClass:"language-Python line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-python"}},[s("code",[t._v("ASYNC_SQLALCHEMY_URI "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string-interpolation"}},[s("span",{pre:!0,attrs:{class:"token string"}},[t._v("f'mysql+aiomysql://")]),s("span",{pre:!0,attrs:{class:"token interpolation"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("MYSQL_USER"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")])]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v(":")]),s("span",{pre:!0,attrs:{class:"token interpolation"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("MYSQL_PWD"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")])]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("@")]),s("span",{pre:!0,attrs:{class:"token interpolation"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("MYSQL_HOST"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")])]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v(":")]),s("span",{pre:!0,attrs:{class:"token interpolation"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("MYSQL_PORT"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")])]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("/")]),s("span",{pre:!0,attrs:{class:"token interpolation"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("DBNAME"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")])]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'")])]),t._v("\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br")])]),s("p",[s("img",{attrs:{src:"https://static.pity.fun/picture/2021-8-8/1628418614732-image.png",alt:"新增异步session和异步engine"}})]),t._v(" "),s("ul",[s("li",[t._v("改造同步方法为异步，以获取测试用例方法为例")])]),t._v(" "),s("p",[s("img",{attrs:{src:"https://static.pity.fun/picture/2021-8-8/1628418733607-image.png",alt:"其实和同步的区别也就4个地方"}})]),t._v(" "),s("ol",[s("li",[t._v("需要改为async方法")]),t._v(" "),s("li",[t._v("with语句要改为async with")]),t._v(" "),s("li",[t._v("select(表).where(条件)，需要用async_session.execute调用")]),t._v(" "),s("li",[t._v("拿数据用result.scalars.first()或者all()都可以，和以前几乎一样")])]),t._v(" "),s("p",[s("img",{attrs:{src:"https://static.pity.fun/picture/2021-8-8/1628418850385-image.png",alt:"改造完了之后记得在调用它的地方也改写一下"}})]),t._v(" "),s("h3",{attrs:{id:"改造之后"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#改造之后"}},[t._v("#")]),t._v(" 改造之后")]),t._v(" "),s("p",[s("img",{attrs:{src:"https://static.pity.fun/picture/2021-8-8/1628419045226-image.png",alt:"异步和同步的关键就是gather"}})]),t._v(" "),s("p",[t._v("虽然没快太多，但是也是有明显进步的，我已经把"),s("code",[t._v("case运行的方法")]),t._v("里面的db操作全部改为了异步。")]),t._v(" "),s("p",[s("img",{attrs:{src:"https://static.pity.fun/picture/2021-8-8/1628418945556-image.png",alt:"快了20秒左右"}})]),t._v(" "),s("p",[t._v("不得不感叹，fastapi还是快的呀！")]),t._v(" "),s("p",[t._v("具体的细节可以参看我的项目: https://github.com/wuranxu/pity。点击"),s("code",[t._v("阅读原文")]),t._v("可以看到整个文章哦！")])])}),[],!1,null,null,null);s.default=n.exports}}]);