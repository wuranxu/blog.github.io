(window.webpackJsonp=window.webpackJsonp||[]).push([[181],{591:function(s,t,a){"use strict";a.r(t);var n=a(2),r=Object(n.a)({},(function(){var s=this,t=s._self._c;return t("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[t("blockquote",[t("p",[s._v("大家好~我是"),t("code",[s._v("米洛")]),s._v("！"),t("br"),s._v("\n我正在从0到1打造一个开源的接口测试平台, 也在编写一套与之对应的完整"),t("code",[s._v("教程")]),s._v("，希望大家多多支持。"),t("br"),s._v("\n欢迎关注我的公众号"),t("code",[s._v("米洛的测开日记")]),s._v("，获取最新文章教程!")])]),s._v(" "),t("h3",{attrs:{id:"回顾"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#回顾"}},[s._v("#")]),s._v(" 回顾")]),s._v(" "),t("p",[s._v("上一节我们编写了Redis的相关配置编辑页面，博主这里也趁热打铁，把"),t("code",[s._v("前端页面")]),s._v("完善了。（可能会有一点点小问题，但应该主流程都正常）")]),s._v(" "),t("p",[s._v("其实和其他配置管理页面差不多，前端优化了一下"),t("code",[s._v("面包屑")]),s._v("，顶部的菜单也放回到左侧了。看看mac下的效果:")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://static.pity.fun/picture/2021-11-14/1636889937000-image.png",alt:"这里我给自己本地部署了个单实例的redis"}})]),s._v(" "),t("p",[s._v("搜索选项改动了一些，所见即所得，如果搜索项发生变化，那么内容也会随之切换")]),s._v(" "),t("h3",{attrs:{id:"关于redis客户端的选用"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#关于redis客户端的选用"}},[s._v("#")]),s._v(" 关于Redis客户端的选用")]),s._v(" "),t("p",[s._v("其实在这个问题上我是比较"),t("code",[s._v("纠结")]),s._v("的，redis有star很多的py客户端，也有与之对应的集群版本。但他们并不支持"),t("code",[s._v("asyncio")]),s._v("。")]),s._v(" "),t("p",[s._v("而支持asyncio的aioredis，本身是个很好的选择，但人家没有支持redis集群的计划。orz")]),s._v(" "),t("p",[s._v("所以今天想的是要不就用个同步的redis-cluster-py库算了，不过在我翻了github一段时间，发现了个叫aredis的异步库。大概瞅了下，他基本上是保持了和redis-cluster-py接近的api，可能也是为了"),t("code",[s._v("吸引用户")]),s._v("。")]),s._v(" "),t("p",[s._v("所以咱们就先试验一下，小白鼠嘛，总得有人来做。")]),s._v(" "),t("h3",{attrs:{id:"安装aredis"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#安装aredis"}},[s._v("#")]),s._v(" 安装aredis")]),s._v(" "),t("p",[s._v("看官网是要安装"),t("code",[s._v("aredis[hiredis]")]),s._v("，但我好像不适合这样方式，于是我分开装:")]),s._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[s._v("pip3 "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("install")]),s._v(" aredis hiredis\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("h3",{attrs:{id:"编写redismanager"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#编写redismanager"}},[s._v("#")]),s._v(" 编写RedisManager")]),s._v(" "),t("p",[s._v("其实这里还是和"),t("code",[s._v("MySQL")]),s._v("比较接近的，也是通过一个字典存放各个redis的连接配置。")]),s._v(" "),t("p",[s._v("不过由于Redis的集群和单实例还有一点区别（好在我们编写配置的时候就准备好了），所以我们最好是针对单实例和集群分别编写2个map存放他们的client，当然1个也是ok的。")]),s._v(" "),t("p",[s._v("整体流程: 从字典获取客户端，如果没有则新开一个客户端，并放入缓存，有则返回。")]),s._v(" "),t("ul",[t("li",[t("p",[s._v("可能存在的问题")]),s._v(" "),t("p",[t("strong",[s._v("代码不是线程安全的，需要观察是否需要加锁")])]),s._v(" "),t("p",[t("strong",[s._v("缓存不像LRU会降频，也不能自动过期")])]),s._v(" "),t("p",[s._v("对我来说第一个肯定是个大问题，如果出现了就必须得解决。至于第二个问题，由于redis配置很少变动，而且我们本身是连接池的形式，所以影响不算大。")]),s._v(" "),t("p",[s._v("话不多说，现在我们就来编写吧:")])])]),s._v(" "),t("div",{staticClass:"language-python line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-python"}},[t("code",[t("span",{pre:!0,attrs:{class:"token triple-quoted-string string"}},[s._v('"""\nredis客户端，基于aredis(支持集群，aioredis不支持集群)\n"""')]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("from")]),s._v(" aredis "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("import")]),s._v(" StrictRedisCluster"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" ClusterConnectionPool"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" ConnectionPool"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" StrictRedis\n\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("from")]),s._v(" app"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("excpetions"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("RedisException "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("import")]),s._v(" RedisException\n\n\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("class")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("PityRedisManager")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token builtin"}},[s._v("object")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token triple-quoted-string string"}},[s._v('"""非线程安全，可能存在问题\n    """')]),s._v("\n    _cluster_pool "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token builtin"}},[s._v("dict")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n    _pool "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token builtin"}},[s._v("dict")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\n    "),t("span",{pre:!0,attrs:{class:"token decorator annotation punctuation"}},[s._v("@staticmethod")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("def")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("get_cluster_client")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("redis_id"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token builtin"}},[s._v("int")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" addr"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token builtin"}},[s._v("str")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token triple-quoted-string string"}},[s._v('"""\n        获取redis集群客户端\n        :param redis_id:\n        :param addr:\n        :return:\n        """')]),s._v("\n        cluster "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" PityRedisManager"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("_cluster_pool"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("get"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("redis_id"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" cluster "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("is")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("not")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("None")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n            "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("return")]),s._v(" cluster\n        client "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" PityRedisManager"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("get_cluster"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("addr"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n        PityRedisManager"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("_cluster_pool"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("redis_id"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" client\n        "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("return")]),s._v(" client\n\n    "),t("span",{pre:!0,attrs:{class:"token decorator annotation punctuation"}},[s._v("@staticmethod")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("def")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("get_single_node_client")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("redis_id"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token builtin"}},[s._v("int")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" addr"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token builtin"}},[s._v("str")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" password"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token builtin"}},[s._v("str")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" db"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token builtin"}},[s._v("str")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token triple-quoted-string string"}},[s._v('"""\n        获取redis单实例客户端\n        :param redis_id:\n        :param addr:\n        :param password:\n        :param db:\n        :return:\n        """')]),s._v("\n        node "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" PityRedisManager"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("_cluster_pool"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("get"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("redis_id"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" node "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("is")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("not")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("None")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n            "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("return")]),s._v(" node\n        host"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" port "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" addr"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("split"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('":"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n        pool "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" ConnectionPool"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("host"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("host"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" port"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("port"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" db"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("db"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" max_connections"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("100")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" password"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("password"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n                              decode_responses"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("True")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n        client "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" StrictRedis"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("connection_pool"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("pool"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n        PityRedisManager"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("_pool"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("redis_id"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" PityRedisManager"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("get_cluster"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("addr"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("return")]),s._v(" client\n\n    "),t("span",{pre:!0,attrs:{class:"token decorator annotation punctuation"}},[s._v("@staticmethod")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("def")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("refresh_redis_client")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("redis_id"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token builtin"}},[s._v("int")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" addr"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token builtin"}},[s._v("str")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" password"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token builtin"}},[s._v("str")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" db"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token builtin"}},[s._v("str")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token triple-quoted-string string"}},[s._v('"""\n        刷新redis客户端\n        :param redis_id:\n        :param addr:\n        :param password:\n        :param db:\n        :return:\n        """')]),s._v("\n        host"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" port "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" addr"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("split"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('":"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n        pool "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" ConnectionPool"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("host"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("host"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" port"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("port"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" db"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("db"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" max_connections"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("100")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" password"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("password"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n                              decode_responses"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("True")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n        client "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" StrictRedis"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("connection_pool"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("pool"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" decode_responses"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("True")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n        PityRedisManager"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("_pool"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("redis_id"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" client\n\n    "),t("span",{pre:!0,attrs:{class:"token decorator annotation punctuation"}},[s._v("@staticmethod")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("def")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("refresh_redis_cluster")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("redis_id"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token builtin"}},[s._v("int")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" addr"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token builtin"}},[s._v("str")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n        PityRedisManager"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("_cluster_pool"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("redis_id"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" PityRedisManager"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("get_cluster"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("addr"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\n    "),t("span",{pre:!0,attrs:{class:"token decorator annotation punctuation"}},[s._v("@staticmethod")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("def")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("get_cluster")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("addr"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token builtin"}},[s._v("str")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token triple-quoted-string string"}},[s._v('"""\n        获取集群连接池\n        :param addr:\n        :return:\n        """')]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("try")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n            nodes "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" addr"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("split"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("','")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n            startup_nodes "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"host"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("split"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('":"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"port"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("split"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('":"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("for")]),s._v(" n "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("in")]),s._v(" nodes"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n            pool "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" ClusterConnectionPool"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("startup_nodes"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("startup_nodes"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" max_connections"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("100")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" decode_responses"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("True")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n            client "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" StrictRedisCluster"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("connection_pool"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("pool"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" decode_responses"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("True")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n            "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("return")]),s._v(" client\n        "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("except")]),s._v(" Exception "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("as")]),s._v(" e"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n            "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("raise")]),s._v(" RedisException"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token string-interpolation"}},[t("span",{pre:!0,attrs:{class:"token string"}},[s._v('f"获取Redis连接失败, ')]),t("span",{pre:!0,attrs:{class:"token interpolation"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("e"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")])]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"')])]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br"),t("span",{staticClass:"line-number"},[s._v("18")]),t("br"),t("span",{staticClass:"line-number"},[s._v("19")]),t("br"),t("span",{staticClass:"line-number"},[s._v("20")]),t("br"),t("span",{staticClass:"line-number"},[s._v("21")]),t("br"),t("span",{staticClass:"line-number"},[s._v("22")]),t("br"),t("span",{staticClass:"line-number"},[s._v("23")]),t("br"),t("span",{staticClass:"line-number"},[s._v("24")]),t("br"),t("span",{staticClass:"line-number"},[s._v("25")]),t("br"),t("span",{staticClass:"line-number"},[s._v("26")]),t("br"),t("span",{staticClass:"line-number"},[s._v("27")]),t("br"),t("span",{staticClass:"line-number"},[s._v("28")]),t("br"),t("span",{staticClass:"line-number"},[s._v("29")]),t("br"),t("span",{staticClass:"line-number"},[s._v("30")]),t("br"),t("span",{staticClass:"line-number"},[s._v("31")]),t("br"),t("span",{staticClass:"line-number"},[s._v("32")]),t("br"),t("span",{staticClass:"line-number"},[s._v("33")]),t("br"),t("span",{staticClass:"line-number"},[s._v("34")]),t("br"),t("span",{staticClass:"line-number"},[s._v("35")]),t("br"),t("span",{staticClass:"line-number"},[s._v("36")]),t("br"),t("span",{staticClass:"line-number"},[s._v("37")]),t("br"),t("span",{staticClass:"line-number"},[s._v("38")]),t("br"),t("span",{staticClass:"line-number"},[s._v("39")]),t("br"),t("span",{staticClass:"line-number"},[s._v("40")]),t("br"),t("span",{staticClass:"line-number"},[s._v("41")]),t("br"),t("span",{staticClass:"line-number"},[s._v("42")]),t("br"),t("span",{staticClass:"line-number"},[s._v("43")]),t("br"),t("span",{staticClass:"line-number"},[s._v("44")]),t("br"),t("span",{staticClass:"line-number"},[s._v("45")]),t("br"),t("span",{staticClass:"line-number"},[s._v("46")]),t("br"),t("span",{staticClass:"line-number"},[s._v("47")]),t("br"),t("span",{staticClass:"line-number"},[s._v("48")]),t("br"),t("span",{staticClass:"line-number"},[s._v("49")]),t("br"),t("span",{staticClass:"line-number"},[s._v("50")]),t("br"),t("span",{staticClass:"line-number"},[s._v("51")]),t("br"),t("span",{staticClass:"line-number"},[s._v("52")]),t("br"),t("span",{staticClass:"line-number"},[s._v("53")]),t("br"),t("span",{staticClass:"line-number"},[s._v("54")]),t("br"),t("span",{staticClass:"line-number"},[s._v("55")]),t("br"),t("span",{staticClass:"line-number"},[s._v("56")]),t("br"),t("span",{staticClass:"line-number"},[s._v("57")]),t("br"),t("span",{staticClass:"line-number"},[s._v("58")]),t("br"),t("span",{staticClass:"line-number"},[s._v("59")]),t("br"),t("span",{staticClass:"line-number"},[s._v("60")]),t("br"),t("span",{staticClass:"line-number"},[s._v("61")]),t("br"),t("span",{staticClass:"line-number"},[s._v("62")]),t("br"),t("span",{staticClass:"line-number"},[s._v("63")]),t("br"),t("span",{staticClass:"line-number"},[s._v("64")]),t("br"),t("span",{staticClass:"line-number"},[s._v("65")]),t("br"),t("span",{staticClass:"line-number"},[s._v("66")]),t("br"),t("span",{staticClass:"line-number"},[s._v("67")]),t("br"),t("span",{staticClass:"line-number"},[s._v("68")]),t("br"),t("span",{staticClass:"line-number"},[s._v("69")]),t("br"),t("span",{staticClass:"line-number"},[s._v("70")]),t("br"),t("span",{staticClass:"line-number"},[s._v("71")]),t("br"),t("span",{staticClass:"line-number"},[s._v("72")]),t("br"),t("span",{staticClass:"line-number"},[s._v("73")]),t("br"),t("span",{staticClass:"line-number"},[s._v("74")]),t("br"),t("span",{staticClass:"line-number"},[s._v("75")]),t("br"),t("span",{staticClass:"line-number"},[s._v("76")]),t("br"),t("span",{staticClass:"line-number"},[s._v("77")]),t("br"),t("span",{staticClass:"line-number"},[s._v("78")]),t("br"),t("span",{staticClass:"line-number"},[s._v("79")]),t("br"),t("span",{staticClass:"line-number"},[s._v("80")]),t("br"),t("span",{staticClass:"line-number"},[s._v("81")]),t("br"),t("span",{staticClass:"line-number"},[s._v("82")]),t("br"),t("span",{staticClass:"line-number"},[s._v("83")]),t("br"),t("span",{staticClass:"line-number"},[s._v("84")]),t("br"),t("span",{staticClass:"line-number"},[s._v("85")]),t("br")])]),t("p",[s._v("我们以数据库的唯一id为key，缓存redis的"),t("code",[s._v("连接池")]),s._v("。")]),s._v(" "),t("p",[s._v("由于连接池会自动开启/关闭连接，所以我们不需要手动关闭客户端，非常方便。")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://static.pity.fun/picture/2021-11-14/1636890801403-image.png",alt:"仔细看看redis执行command的方法，里面会开辟连接，最终关闭连接，这就是连接池的好处，连接不会过期，因为每次都是新获取的"}})]),s._v(" "),t("p",[s._v("可以明显看到我们分别用了ClusterConnectionPool和ConnectionPool，分别对应集群和实例。参数基本上算是一致。")]),s._v(" "),t("p",[s._v("至于refresh，是给改动redis以后做的"),t("code",[s._v("刷新连接")]),s._v("的工作。")]),s._v(" "),t("p",[s._v("以上就是RedisManager的内容，到这只是能够获取Redis客户端了。")]),s._v(" "),t("h3",{attrs:{id:"尝试一下"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#尝试一下"}},[s._v("#")]),s._v(" 尝试一下")]),s._v(" "),t("p",[s._v("有条件的同学可以本次安装redis:")]),s._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[s._v("$ "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("wget")]),s._v(" https://download.redis.io/releases/redis-6.2.6.tar.gz\n$ "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("tar")]),s._v(" xzf redis-6.2.6.tar.gz\n$ "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("cd")]),s._v(" redis-6.2.6\n$ "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("make")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br")])]),t("p",[s._v("make了以后，修改redis-6.2.6目录下的redis.conf, 接着取消这一行的注释:")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://static.pity.fun/picture/2021-11-14/1636890999517-image.png",alt:""}})]),s._v(" "),t("p",[s._v("使用密码模式（redis最好是加密码，端口号也尽量不要用原生的6379，本宝宝有台机器被人通过redis植入了挖矿程序，"),t("code",[s._v("苦不堪言")]),s._v("）")]),s._v(" "),t("ul",[t("li",[s._v("在redis-6.2.6目录下启动")])]),s._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[s._v("src/redis-server redis.conf\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("p",[s._v("这样本地redis的实例就启动了~")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://static.pity.fun/picture/2021-11-14/1636891245569-image.png",alt:""}})]),s._v(" "),t("h3",{attrs:{id:"编写个在线测试redis的接口"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#编写个在线测试redis的接口"}},[s._v("#")]),s._v(" 编写个在线测试redis的接口")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://static.pity.fun/picture/2021-11-14/1636891192849-image.png",alt:""}})]),s._v(" "),t("ul",[t("li",[t("p",[s._v("先通过id拿到redis的配置信息")])]),s._v(" "),t("li",[t("p",[s._v("然后通过manager拿到连接池")])]),s._v(" "),t("li",[t("p",[s._v("对redis发动命令")]),s._v(" "),t("p",[s._v("我们在http://localhost:7777/docs打开swagger调试:")])]),s._v(" "),t("li",[t("p",[s._v("读取faker")])])]),s._v(" "),t("p",[t("img",{attrs:{src:"https://static.pity.fun/picture/2021-11-14/1636891330900-image.png",alt:""}})]),s._v(" "),t("ul",[t("li",[s._v("设置faker为s12")])]),s._v(" "),t("p",[t("img",{attrs:{src:"https://static.pity.fun/picture/2021-11-14/1636891376666-image.png",alt:""}})]),s._v(" "),t("ul",[t("li",[s._v("再次取faker")])]),s._v(" "),t("p",[t("img",{attrs:{src:"https://static.pity.fun/picture/2021-11-14/1636891400135-image.png",alt:""}})]),s._v(" "),t("p",[s._v("可以看到redis的相关操作已经是可以用了，那我们今天的内容就到这了，愉快的周末总是辣么"),t("code",[s._v("短暂")]),s._v("。")]),s._v(" "),t("p",[s._v("下一节我们就得编写在线执行Redis的命令及相关页面了！")])])}),[],!1,null,null,null);t.default=r.exports}}]);