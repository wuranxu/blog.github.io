(window.webpackJsonp=window.webpackJsonp||[]).push([[175],{585:function(t,s,a){"use strict";a.r(s);var n=a(2),e=Object(n.a)({},(function(){var t=this,s=t._self._c;return s("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[s("blockquote",[s("p",[t._v("大家好~我是"),s("code",[t._v("米洛")]),t._v("！"),s("br"),t._v("\n我正在从0到1打造一个开源的接口测试平台, 也在编写一套与之对应的完整"),s("code",[t._v("教程")]),t._v("，希望大家多多支持。"),s("br"),t._v("\n欢迎关注我的公众号"),s("code",[t._v("米洛的测开日记")]),t._v("，获取最新文章教程!")])]),t._v(" "),s("h3",{attrs:{id:"回顾"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#回顾"}},[t._v("#")]),t._v(" 回顾")]),t._v(" "),s("p",[t._v("上一节我们设计好了"),s("code",[t._v("测试计划")]),t._v("表并编写了CRUD接口，还没来得及测试，我们就要马不停蹄地编写定时任务相关内容了。今天我们就来编写一个完善的demo，可以定期执行"),s("code",[t._v("测试计划")]),t._v("的用例，并生成报告。")]),t._v(" "),s("p",[t._v("至于后面的通知，要等到以后完善了。")]),t._v(" "),s("h3",{attrs:{id:"调整executor类里面的部分方法"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#调整executor类里面的部分方法"}},[t._v("#")]),t._v(" 调整Executor类里面的部分方法")]),t._v(" "),s("p",[t._v("之前我们虽然支持了"),s("code",[t._v("多条case")]),t._v("异步运行并写入测试报告，但为了支持"),s("code",[t._v("测试计划")]),t._v("，我们还需要进行一些调整。")]),t._v(" "),s("ul",[s("li",[s("p",[t._v("修改run_multiple方法")]),t._v(" "),s("p",[t._v("我们的"),s("code",[t._v("核心")]),t._v("还是这个方法，因为里面已经包装好了运行多条case的方法。但我们要做一些改动:")])])]),t._v(" "),s("p",[s("img",{attrs:{src:"https://static.pity.fun/picture/2021-10-31/1635672743576-image.png",alt:"变更参数"}})]),t._v(" "),s("p",[t._v("首先我们要调整它的参数，因为我们运行case的模式，有很多种，按照之前定义的mode字段:")]),t._v(" "),s("p",[s("img",{attrs:{src:"https://static.pity.fun/picture/2021-10-31/1635672799093-image.png",alt:"这个是测试报告表中定义的"}})]),t._v(" "),s("p",[s("img",{attrs:{src:"https://static.pity.fun/picture/2021-10-31/1635672958819-image.png",alt:"调整一下"}})]),t._v(" "),s("p",[t._v("这样，当我们调用run_mutiple方法的时候，就可以知道case的模式是什么模式了，究竟是隶属于"),s("code",[t._v("测试计划")]),t._v("呢，还是属于"),s("code",[t._v("普通执行的case")]),t._v("。我们调整一下，改成图2的数据。")]),t._v(" "),s("p",[t._v("plan_id可以为空，如果有plan_id的话，可以直接跳转到"),s("code",[t._v("测试计划")]),t._v("相关页面。方便编辑测试计划，也方便排查问题。")]),t._v(" "),s("p",[t._v("ordered这个方法区分"),s("strong",[t._v("同步")]),t._v("还是"),s("strong",[t._v("异步")]),t._v("，因为我们先前的run_multiple都是默认异步的，但我们测试计划又新增了"),s("strong",[t._v("同步模式")]),t._v("，所以需要定义这样一个"),s("strong",[t._v("参数")]),t._v("。")]),t._v(" "),s("ul",[s("li",[t._v("修改ReportDao")])]),t._v(" "),s("p",[s("img",{attrs:{src:"https://static.pity.fun/picture/2021-10-31/1635673135314-image.png",alt:""}})]),t._v(" "),s("p",[t._v("也是添加这2个参数，透传进来。方便报告里面表明，这是什么模式的执行，以及是否有测试计划id。")]),t._v(" "),s("ul",[s("li",[t._v("调整执行逻辑")])]),t._v(" "),s("p",[s("img",{attrs:{src:"https://static.pity.fun/picture/2021-10-31/1635673219635-image.png",alt:""}})]),t._v(" "),s("p",[t._v("根据ordered字段判断是否是"),s("code",[t._v("同步执行")]),t._v("，如果不是则和以前一致，是的话则用for的方式执行，"),s("strong",[t._v("保证用例执行的顺序性")]),t._v("。")]),t._v(" "),s("h3",{attrs:{id:"新增run-test-plan方法"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#新增run-test-plan方法"}},[t._v("#")]),t._v(" 新增run_test_plan方法")]),t._v(" "),s("div",{staticClass:"language-python line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-python"}},[s("code",[t._v("    "),s("span",{pre:!0,attrs:{class:"token decorator annotation punctuation"}},[t._v("@staticmethod")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("async")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("def")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("run_test_plan")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("plan_id"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("int")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token triple-quoted-string string"}},[t._v('"""\n        通过测试计划id执行测试计划\n        :param plan_id:\n        :return:\n        """')]),t._v("\n        plan "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("await")]),t._v(" PityTestPlanDao"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("query_test_plan"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("plan_id"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" plan "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("is")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("None")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n            Executor"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("log"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("info"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string-interpolation"}},[s("span",{pre:!0,attrs:{class:"token string"}},[t._v('f"测试计划: [')]),s("span",{pre:!0,attrs:{class:"token interpolation"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("plan_id"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")])]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v(']不存在"')])]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n            "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 设置为running")]),t._v("\n        plan"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("state "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("await")]),t._v(" PityTestPlanDao"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("update_test_plan"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("plan"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" plan"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("update_user"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# if plan.disabled:")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#     # 说明测试计划已禁用")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v('#     Executor.log.info(f"测试计划: [{plan.name}]未开启")')]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#     return")]),t._v("\n        env "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("list")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("map")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("int")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" plan"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("env"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("split"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('","')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n        case_list "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("list")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("map")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("int")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" plan"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("case_list"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("split"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('","')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("await")]),t._v(" asyncio"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("gather"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("\n            "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("Executor"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("run_multiple"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("int")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("e"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" case_list"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" mode"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n                                    plan_id"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("plan"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("id")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" ordered"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("plan"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("ordered"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("for")]),t._v(" e "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("in")]),t._v(" env"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# TODO 后续通知部分")]),t._v("\n        plan"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("state "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("await")]),t._v(" PityTestPlanDao"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("update_test_plan"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("plan"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" plan"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("update_user"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br"),s("span",{staticClass:"line-number"},[t._v("2")]),s("br"),s("span",{staticClass:"line-number"},[t._v("3")]),s("br"),s("span",{staticClass:"line-number"},[t._v("4")]),s("br"),s("span",{staticClass:"line-number"},[t._v("5")]),s("br"),s("span",{staticClass:"line-number"},[t._v("6")]),s("br"),s("span",{staticClass:"line-number"},[t._v("7")]),s("br"),s("span",{staticClass:"line-number"},[t._v("8")]),s("br"),s("span",{staticClass:"line-number"},[t._v("9")]),s("br"),s("span",{staticClass:"line-number"},[t._v("10")]),s("br"),s("span",{staticClass:"line-number"},[t._v("11")]),s("br"),s("span",{staticClass:"line-number"},[t._v("12")]),s("br"),s("span",{staticClass:"line-number"},[t._v("13")]),s("br"),s("span",{staticClass:"line-number"},[t._v("14")]),s("br"),s("span",{staticClass:"line-number"},[t._v("15")]),s("br"),s("span",{staticClass:"line-number"},[t._v("16")]),s("br"),s("span",{staticClass:"line-number"},[t._v("17")]),s("br"),s("span",{staticClass:"line-number"},[t._v("18")]),s("br"),s("span",{staticClass:"line-number"},[t._v("19")]),s("br"),s("span",{staticClass:"line-number"},[t._v("20")]),s("br"),s("span",{staticClass:"line-number"},[t._v("21")]),s("br"),s("span",{staticClass:"line-number"},[t._v("22")]),s("br"),s("span",{staticClass:"line-number"},[t._v("23")]),s("br"),s("span",{staticClass:"line-number"},[t._v("24")]),s("br"),s("span",{staticClass:"line-number"},[t._v("25")]),s("br"),s("span",{staticClass:"line-number"},[t._v("26")]),s("br")])]),s("p",[t._v("先通过query方法查到测试计划数据，如果plan是None，说明没有这个测试计划，可能被"),s("code",[t._v("删掉")]),t._v("了。")]),t._v(" "),s("p",[t._v("否则我们走执行逻辑: 根据plan的env字段取出环境，并转换为[1, 2]这样的数组。")]),t._v(" "),s("p",[s("strong",[t._v("这里可能有点绕，因为我们数据库存的env和case_list都是这样的形式:")])]),t._v(" "),s("p",[s("code",[t._v("1,2,3,4")])]),t._v(" "),s("p",[s("strong",[t._v('通过逗号分开，我们split以后，会得到: ["1", "2", "3", "4"]这样的数组，所以我们需要批量转为int。')])]),t._v(" "),s("p",[t._v("最后，由于一般环境之间会"),s("code",[t._v("隔离")]),t._v("，所以我们的ordered根据环境走就可以了，多环境执行我们可以按照异步处理。")]),t._v(" "),s("p",[t._v("所以最后也选用了gather。")]),t._v(" "),s("h3",{attrs:{id:"编写scheduler类"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#编写scheduler类"}},[t._v("#")]),t._v(" 编写Scheduler类")]),t._v(" "),s("p",[t._v("我们在utils目录下新建scheduler.py文件:")]),t._v(" "),s("div",{staticClass:"language-python line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-python"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("from")]),t._v(" apscheduler"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("schedulers"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("asyncio "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" AsyncIOScheduler\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("from")]),t._v(" apscheduler"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("triggers"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("cron "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" CronTrigger\n\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("from")]),t._v(" app"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("utils"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("executor "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" Executor\n\n\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("class")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Scheduler")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("object")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    scheduler"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" AsyncIOScheduler "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("None")]),t._v("\n\n    "),s("span",{pre:!0,attrs:{class:"token decorator annotation punctuation"}},[t._v("@staticmethod")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("def")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("init")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("scheduler"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n        Scheduler"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("scheduler "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" scheduler\n\n    "),s("span",{pre:!0,attrs:{class:"token decorator annotation punctuation"}},[t._v("@staticmethod")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("def")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("configure")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("**")]),t._v("kwargs"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n        Scheduler"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("scheduler"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("configure"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("**")]),t._v("kwargs"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\n    "),s("span",{pre:!0,attrs:{class:"token decorator annotation punctuation"}},[t._v("@staticmethod")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("def")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("start")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n        Scheduler"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("scheduler"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("start"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\n    "),s("span",{pre:!0,attrs:{class:"token decorator annotation punctuation"}},[t._v("@staticmethod")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("def")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("add_test_plan")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("plan_id"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" plan_name"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" cron"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" Scheduler"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("scheduler"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("add_job"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("func"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("Executor"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("run_test_plan"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" args"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("plan_id"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n                                           name"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("plan_name"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("id")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("str")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("plan_id"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n                                           trigger"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("CronTrigger"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("from_crontab"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("cron"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\n    "),s("span",{pre:!0,attrs:{class:"token decorator annotation punctuation"}},[t._v("@staticmethod")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("def")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("edit")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("pass")]),t._v("\n\n    "),s("span",{pre:!0,attrs:{class:"token decorator annotation punctuation"}},[t._v("@staticmethod")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("def")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("remove")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("pass")]),t._v("\n\n    "),s("span",{pre:!0,attrs:{class:"token decorator annotation punctuation"}},[t._v("@staticmethod")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("def")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("list")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n        job_list "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" Scheduler"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("scheduler"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("get_jobs"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" job_list\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br"),s("span",{staticClass:"line-number"},[t._v("2")]),s("br"),s("span",{staticClass:"line-number"},[t._v("3")]),s("br"),s("span",{staticClass:"line-number"},[t._v("4")]),s("br"),s("span",{staticClass:"line-number"},[t._v("5")]),s("br"),s("span",{staticClass:"line-number"},[t._v("6")]),s("br"),s("span",{staticClass:"line-number"},[t._v("7")]),s("br"),s("span",{staticClass:"line-number"},[t._v("8")]),s("br"),s("span",{staticClass:"line-number"},[t._v("9")]),s("br"),s("span",{staticClass:"line-number"},[t._v("10")]),s("br"),s("span",{staticClass:"line-number"},[t._v("11")]),s("br"),s("span",{staticClass:"line-number"},[t._v("12")]),s("br"),s("span",{staticClass:"line-number"},[t._v("13")]),s("br"),s("span",{staticClass:"line-number"},[t._v("14")]),s("br"),s("span",{staticClass:"line-number"},[t._v("15")]),s("br"),s("span",{staticClass:"line-number"},[t._v("16")]),s("br"),s("span",{staticClass:"line-number"},[t._v("17")]),s("br"),s("span",{staticClass:"line-number"},[t._v("18")]),s("br"),s("span",{staticClass:"line-number"},[t._v("19")]),s("br"),s("span",{staticClass:"line-number"},[t._v("20")]),s("br"),s("span",{staticClass:"line-number"},[t._v("21")]),s("br"),s("span",{staticClass:"line-number"},[t._v("22")]),s("br"),s("span",{staticClass:"line-number"},[t._v("23")]),s("br"),s("span",{staticClass:"line-number"},[t._v("24")]),s("br"),s("span",{staticClass:"line-number"},[t._v("25")]),s("br"),s("span",{staticClass:"line-number"},[t._v("26")]),s("br"),s("span",{staticClass:"line-number"},[t._v("27")]),s("br"),s("span",{staticClass:"line-number"},[t._v("28")]),s("br"),s("span",{staticClass:"line-number"},[t._v("29")]),s("br"),s("span",{staticClass:"line-number"},[t._v("30")]),s("br"),s("span",{staticClass:"line-number"},[t._v("31")]),s("br"),s("span",{staticClass:"line-number"},[t._v("32")]),s("br"),s("span",{staticClass:"line-number"},[t._v("33")]),s("br"),s("span",{staticClass:"line-number"},[t._v("34")]),s("br"),s("span",{staticClass:"line-number"},[t._v("35")]),s("br"),s("span",{staticClass:"line-number"},[t._v("36")]),s("br"),s("span",{staticClass:"line-number"},[t._v("37")]),s("br"),s("span",{staticClass:"line-number"},[t._v("38")]),s("br"),s("span",{staticClass:"line-number"},[t._v("39")]),s("br")])]),s("p",[t._v("这里我们对scheduler进行了非常简单的封装，然后定义了add_test_plan方法。")]),t._v(" "),s("p",[t._v("这个方法可以添加"),s("code",[t._v("Executor.run_test_plan")]),t._v("到定时任务，他接受id，name和cron3个参数，这个数据最终会落到"),s("code",[t._v("定时任务表")]),t._v("里面去。")]),t._v(" "),s("h3",{attrs:{id:"在添加测试计划接口调用add-test-plan方法"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#在添加测试计划接口调用add-test-plan方法"}},[t._v("#")]),t._v(" 在添加测试计划接口调用add_test_plan方法")]),t._v(" "),s("p",[s("img",{attrs:{src:"https://static.pity.fun/picture/2021-10-31/1635675788299-image.png",alt:"当测试计划添加成功的时候，我们自动添加定时任务"}})]),t._v(" "),s("h3",{attrs:{id:"测试一下"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#测试一下"}},[t._v("#")]),t._v(" 测试一下")]),t._v(" "),s("p",[t._v("FastApi深度结合了Swagger，所以我们只需要打开: http://localhost:7777/docs便可以找到我们的测试方法:")]),t._v(" "),s("p",[s("img",{attrs:{src:"https://static.pity.fun/picture/2021-10-31/1635675894577-image.png",alt:"填入token和测试计划相关信息即可"}})]),t._v(" "),s("p",[t._v("由于我已经添加过了，并且是每分钟一次，所以我们只需要启动服务，"),s("code",[t._v("静静等待")]),t._v("即可。")]),t._v(" "),s("p",[s("img",{attrs:{src:"https://static.pity.fun/picture/2021-10-31/1635675952044-image.png",alt:"启动服务的时候，提示我这个每分钟执行的任务被miss了，我们再等一分钟"}})]),t._v(" "),s("p",[s("img",{attrs:{src:"https://static.pity.fun/picture/2021-10-31/1635676129574-image.png",alt:"可以看到，环境1和环境2保持每分钟都在写入测试报告到数据库"}})]),t._v(" "),s("p",[s("img",{attrs:{src:"https://static.pity.fun/picture/2021-10-31/1635676564895-image.png",alt:""}})]),t._v(" "),s("p",[t._v("那今天的简单demo就完成到这里，下一节我们完善删改查的内容。")])])}),[],!1,null,null,null);s.default=e.exports}}]);