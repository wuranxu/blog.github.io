(window.webpackJsonp=window.webpackJsonp||[]).push([[85],{486:function(s,t,a){"use strict";a.r(t);var n=a(2),e=Object(n.a)({},(function(){var s=this,t=s._self._c;return t("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[t("blockquote",[t("p",[s._v("大家好~我是"),t("code",[s._v("米洛")]),s._v("！"),t("br"),s._v("\n我正在从0到1打造一个开源的接口测试平台, 也在编写一套与之对应的"),t("code",[s._v("教程")]),s._v("，希望大家多多支持。"),t("br"),s._v("\n欢迎关注我的公众号"),t("code",[s._v("米洛的测开日记")]),s._v("，获取最新文章教程!")])]),s._v(" "),t("h3",{attrs:{id:"回顾"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#回顾"}},[s._v("#")]),s._v(" 回顾")]),s._v(" "),t("p",[s._v("上一节我们完成了mitmproxy的demo版本，这一节我们来大刀阔斧，利用mitmproxy录制我们需要的"),t("code",[s._v("接口请求")]),s._v("。")]),s._v(" "),t("p",[s._v("录制了以后，下一节我们估计是要存取/解析这些请求，最后一步就是转换为"),t("code",[s._v("pity")]),s._v("的测试用例了。当然，为了通用，最好我们也能支持har/jmx等其他文件的导入。")]),s._v(" "),t("h3",{attrs:{id:"录制流程"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#录制流程"}},[s._v("#")]),s._v(" 录制流程")]),s._v(" "),t("ol",[t("li",[s._v("用户在页面输入要录制的url")]),s._v(" "),t("li",[s._v("用户点击开始录制，服务端将用户的ip存放到redis中，这样用户就算中途离开，刷新页面依然能看到对应的录制数据和录制仍在进行中的状态")]),s._v(" "),t("li",[s._v("用户点击停止录制按钮，结束录制，后续就是用例的生成工作了")])]),s._v(" "),t("p",[s._v("本节分2部分，建议配合起来阅读。先给大家看个概览:")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://static.pity.fun/picture/20220608230429.png",alt:""}})]),s._v(" "),t("h3",{attrs:{id:"配置代理"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#配置代理"}},[s._v("#")]),s._v(" 配置代理")]),s._v(" "),t("p",[s._v("根据mitmproxy官网可知，他们需要至少python3.8以上，所以大家也趁这个机会升级一下python吧~毕竟3.8也发布很久了。")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://static.pity.fun/picture/20220608223548.png",alt:""}})]),s._v(" "),t("p",[s._v("接着我们需要先安装mitmproxy，因为他需要随着我们的服务启动:")]),s._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[s._v("pip "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("install")]),s._v(" mitmproxy\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("p",[s._v("安装好以后，我们来配置我们的MITMPROXY启动端口，暂定为7778吧~")]),s._v(" "),t("p",[s._v("由于配置文件我有些许改动，可以参考下文档: "),t("a",{attrs:{href:"https://fastapi.tiangolo.com/advanced/settings/#reading-a-env-file",target:"_blank",rel:"noopener noreferrer"}},[s._v("https://fastapi.tiangolo.com/advanced/settings/#reading-a-env-file"),t("OutboundLink")],1)]),s._v(" "),t("p",[s._v("这里就不细说了。基本用法和之前类似，只不过是从conf/dev.env里面读取配置。")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://static.pity.fun/picture/20220608224720.png",alt:""}})]),s._v(" "),t("p",[s._v("我们开启mock并且设置好对应的端口号。")]),s._v(" "),t("h3",{attrs:{id:"编写redis缓存接口请求的方法"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#编写redis缓存接口请求的方法"}},[s._v("#")]),s._v(" 编写Redis缓存接口请求的方法")]),s._v(" "),t("p",[s._v("我的计划是把临时录制的请求（保存1小时）放入redis，与该用户的ip绑定，如果1小时内用户暂时离开，比如去上了个"),t("code",[s._v("厕所")]),s._v("，回来也能继续操作。")]),s._v(" "),t("p",[s._v("所以我们需要写一个redis缓存接口请求的方法，下面是代码:")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://static.pity.fun/picture/20220608225909.png",alt:""}})]),s._v(" "),t("p",[s._v("我们用列表存放这个用户录制的请求（利用ip地址的唯一性保证key的唯一），接着判断这个key是否设置了过期时间，如果没有则给它设置1小时的过期时间。")]),s._v(" "),t("h3",{attrs:{id:"编写proxy插件"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#编写proxy插件"}},[s._v("#")]),s._v(" 编写proxy插件")]),s._v(" "),t("p",[s._v("我们现在开始动手编写一个录制插件，看过上篇文章的观众应该都很熟悉。")]),s._v(" "),t("div",{staticClass:"language-python line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-python"}},[t("code",[t("span",{pre:!0,attrs:{class:"token triple-quoted-string string"}},[s._v('"""\n流量录制->生成case功能\nrecord steps and generate testcase\n"""')]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("import")]),s._v(" asyncio\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("import")]),s._v(" json\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("import")]),s._v(" re\n\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("from")]),s._v(" app"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("core"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("ws_connection_manager "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("import")]),s._v(" ws_manage\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("from")]),s._v(" app"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("enums"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("MessageEnum "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("import")]),s._v(" WebSocketMessageEnum\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("from")]),s._v(" app"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("middleware"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("RedisManager "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("import")]),s._v(" RedisHelper\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("from")]),s._v(" app"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("proxy"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("utils "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("import")]),s._v(" RequestInfo\n\n\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("class")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("PityRecorder")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token builtin"}},[s._v("object")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n\n    "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("async")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("def")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("response")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("self"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" flow"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 获取当前录制到的客户端ip地址")]),s._v("\n        addr "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" flow"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("client_conn"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("address"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 判断这个ip是否开启了录制，没开启的话，直接return")]),s._v("\n        record "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("await")]),s._v(" RedisHelper"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("get_address_record"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("addr"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("not")]),s._v(" record"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n            "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("return")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 获取录制的url信息")]),s._v("\n        data "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" json"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("loads"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("record"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 判断当前的url是否和配置的url匹配")]),s._v("\n        pattern "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" re"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token builtin"}},[s._v("compile")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("data"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("get"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"regex"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 如果匹配则继续")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" re"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("findall"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("pattern"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" flow"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("request"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("url"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n            "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 忽略js、css等文件 忽略options请求")]),s._v("\n            "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" flow"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("request"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("method"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("lower"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("==")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"options"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n                "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("return")]),s._v("\n            "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" flow"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("request"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("url"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("endswith"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"js"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"css"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"ttf"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"jpg"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"svg"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"gif"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n                "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("return")]),s._v("\n            "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 说明已开启录制开关，记录状态 这里将flow里面的request进行了转换")]),s._v("\n            request_data "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" RequestInfo"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("flow"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n            "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 序列化为str，方便存入redis")]),s._v("\n            dump_data "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" request_data"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("dumps"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n            "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 记录录制的接口数据")]),s._v("\n            "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("await")]),s._v(" RedisHelper"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("cache_record"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("addr"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" dump_data"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n            "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 通过websocket发送到录制页面，使页面生成最新的数据")]),s._v("\n            asyncio"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("create_task"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("ws_manage"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("send_data"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("data"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("get"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"user_id"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" WebSocketMessageEnum"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("RECORD"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n                                                    dump_data"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br"),t("span",{staticClass:"line-number"},[s._v("18")]),t("br"),t("span",{staticClass:"line-number"},[s._v("19")]),t("br"),t("span",{staticClass:"line-number"},[s._v("20")]),t("br"),t("span",{staticClass:"line-number"},[s._v("21")]),t("br"),t("span",{staticClass:"line-number"},[s._v("22")]),t("br"),t("span",{staticClass:"line-number"},[s._v("23")]),t("br"),t("span",{staticClass:"line-number"},[s._v("24")]),t("br"),t("span",{staticClass:"line-number"},[s._v("25")]),t("br"),t("span",{staticClass:"line-number"},[s._v("26")]),t("br"),t("span",{staticClass:"line-number"},[s._v("27")]),t("br"),t("span",{staticClass:"line-number"},[s._v("28")]),t("br"),t("span",{staticClass:"line-number"},[s._v("29")]),t("br"),t("span",{staticClass:"line-number"},[s._v("30")]),t("br"),t("span",{staticClass:"line-number"},[s._v("31")]),t("br"),t("span",{staticClass:"line-number"},[s._v("32")]),t("br"),t("span",{staticClass:"line-number"},[s._v("33")]),t("br"),t("span",{staticClass:"line-number"},[s._v("34")]),t("br"),t("span",{staticClass:"line-number"},[s._v("35")]),t("br"),t("span",{staticClass:"line-number"},[s._v("36")]),t("br"),t("span",{staticClass:"line-number"},[s._v("37")]),t("br"),t("span",{staticClass:"line-number"},[s._v("38")]),t("br"),t("span",{staticClass:"line-number"},[s._v("39")]),t("br"),t("span",{staticClass:"line-number"},[s._v("40")]),t("br"),t("span",{staticClass:"line-number"},[s._v("41")]),t("br"),t("span",{staticClass:"line-number"},[s._v("42")]),t("br"),t("span",{staticClass:"line-number"},[s._v("43")]),t("br"),t("span",{staticClass:"line-number"},[s._v("44")]),t("br")])]),t("p",[s._v("注释里面写的很详尽，这里面有一部分代码还没有实现，涉及到的是redis和websocket那块，大体意思大家能理解即可。")]),s._v(" "),t("p",[s._v("接着我们要将插件挂载到mitmproxy:")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://static.pity.fun/picture/20220608230906.png",alt:""}})]),s._v(" "),t("p",[s._v("app/proxy/__init__.py里面包裹了一个start_proxy的方法，先判断用户是否安装了mitmproxy，接着把recorder插件挂载进来，利用DumpMaster启动mitmproxy即可。")]),s._v(" "),t("p",[s._v("上面就是本节内容，下一节我们具体细化websocket、redis还有前端部分内容，敬请期待。")])])}),[],!1,null,null,null);t.default=e.exports}}]);