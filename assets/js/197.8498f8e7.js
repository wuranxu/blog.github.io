(window.webpackJsonp=window.webpackJsonp||[]).push([[197],{609:function(s,t,a){"use strict";a.r(t);var n=a(2),e=Object(n.a)({},(function(){var s=this,t=s._self._c;return t("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[t("blockquote",[t("p",[s._v("大家好~我是"),t("code",[s._v("米洛")]),s._v("！"),t("br"),s._v("\n我正在从0到1打造一个开源的接口测试平台, 也在编写一套与之对应的"),t("code",[s._v("教程")]),s._v("，希望大家多多支持。"),t("br"),s._v("\n欢迎关注我的公众号"),t("code",[s._v("米洛的测开日记")]),s._v("，获取最新文章教程!")])]),s._v(" "),t("h3",{attrs:{id:"回顾"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#回顾"}},[s._v("#")]),s._v(" 回顾")]),s._v(" "),t("p",[s._v("上一节我们的前置条件支持了"),t("code",[s._v("python脚本")]),s._v("类型，让我们能够更灵活处理数据了。")]),s._v(" "),t("p",[s._v("今天我们就玩点好玩的，和大家一起探讨："),t("strong",[s._v("怎么停止一段python代码")]),s._v("。之后我们将会运用到pity之中。")]),s._v(" "),t("h3",{attrs:{id:"知识要点"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#知识要点"}},[s._v("#")]),s._v(" 知识要点")]),s._v(" "),t("p",[s._v("本文需要大家对"),t("code",[s._v("asyncio")]),s._v("相关知识有一些了解，至于原理方面，大家可以自行查阅，因为我也没细看。")]),s._v(" "),t("h3",{attrs:{id:"为什么要做这个"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#为什么要做这个"}},[s._v("#")]),s._v(" 为什么要做这个？")]),s._v(" "),t("p",[s._v("针对"),t("code",[s._v("测试任务")]),s._v("执行非常久的时候，看起来会是阻塞的情况，举个例子:")]),s._v(" "),t("p",[s._v("某个python脚本里面写了time.sleep(1000)，导致你的case一直好像没有执行完成，那我们想结束它，该咋整呢？")]),s._v(" "),t("p",[s._v("今天博主要聊的就是这方面的内容。")]),s._v(" "),t("h3",{attrs:{id:"先看看-难题"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#先看看-难题"}},[s._v("#")]),s._v(' 先看看"难题"')]),s._v(" "),t("p",[s._v("我们来写一个简单的demo。")]),s._v(" "),t("ul",[t("li",[s._v("我们先定义一个异步无限循环的方法，让它每隔一秒就打印一行内容")])]),s._v(" "),t("div",{staticClass:"language-python line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-python"}},[t("code",[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("import")]),s._v(" asyncio\n\n\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("async")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("def")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("run")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("while")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("True")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("print")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"still alive"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("await")]),s._v(" asyncio"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("sleep"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br")])]),t("p",[s._v("试想一下，如果这个方法开启了，不结束它，"),t("code",[s._v("它是不是会一直打印下去")]),s._v("？没错，我们先试试直接运行之:")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://static.pity.fun/picture/2021-12-11/1639197382000-image.png",alt:""}})]),s._v(" "),t("p",[s._v("很显然，它是绝对不会停止的，除非你关闭这个py程序。")]),s._v(" "),t("p",[s._v("我们把它"),t("code",[s._v("想象成")]),s._v("同步方法，是不是也会遇到这个困难:")]),s._v(" "),t("div",{staticClass:"language-python line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-python"}},[t("code",[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("import")]),s._v(" time\n\n\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("def")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("run")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    time"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("sleep"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("10000")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n    \n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" __name__ "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("==")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"__main__"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    run"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("print")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"done"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br")])]),t("p",[s._v("可以发现run一旦开始，它就"),t("code",[s._v("阻塞")]),s._v("了整个程序，下面的done必须要等run结束了才能打印出来。")]),s._v(" "),t("h3",{attrs:{id:"怎么停止run"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#怎么停止run"}},[s._v("#")]),s._v(" 怎么停止run")]),s._v(" "),t("p",[s._v("我们都知道，在python3.4以后新增了异步编程相关的概念，最初是由@coroutine这样的装饰器放到方法上，把方法标注为"),t("code",[s._v("异步方法")]),s._v("，后面直接从语言层面支持了异步方法定义(async)，那其实里面还有很多我们不太常用的部分，比如今天要说的create_task。")]),s._v(" "),t("ul",[t("li",[s._v("我们改写下方法")])]),s._v(" "),t("div",{staticClass:"language-python line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-python"}},[t("code",[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("import")]),s._v(" asyncio\n\n\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("async")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("def")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("run")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("while")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("True")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("print")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"still alive"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("await")]),s._v(" asyncio"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("sleep"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n        \n        \n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("async")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("def")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("main")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("await")]),s._v(" asyncio"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("create_task"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("run"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\n\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" __name__ "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("==")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"__main__"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    asyncio"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("run"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("main"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br")])]),t("p",[s._v("这次我们包了一层方法，利用"),t("code",[s._v("asyncio.create_task")]),s._v("来创建异步任务，create_task接收一个coroutine并执行。")]),s._v(" "),t("p",[s._v("执行之后，可以发现这个和上面的情况，任务也会一直进行下去。")]),s._v(" "),t("p",[s._v("我们继续下一步改造:")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://static.pity.fun/picture/2021-12-11/1639197857219-image.png",alt:""}})]),s._v(" "),t("p",[s._v("我们去掉"),t("code",[s._v("await")]),s._v("，可以看到run方法确实执行了，但是still alive只打印了一次就结束了。")]),s._v(" "),t("p",[s._v("我对它的理解是，虽然create_task创建了一个"),t("code",[s._v("异步任务")]),s._v("，但没说要await，也就是说没有说要等它结束。")]),s._v(" "),t("p",[s._v("想象一下这些异步任务都由一个事件循环控制，当你执行main(main本身也是一个异步任务)的时候，asyncio.run默认是要执行到"),t("code",[s._v("main方法")]),s._v("执行完毕的，也就是说，现在事件循环等待main方法执行完毕，main方法里面又创建了一个异步任务，但没有强调需要该任务完成，创建完毕后，由于main任务已经完成了，就导致整个事件结束了。")]),s._v(" "),t("p",[s._v("梳理一下:")]),s._v(" "),t("ul",[t("li",[t("p",[s._v("有await")]),s._v(" "),t("p",[t("strong",[s._v("线程开启 -> 执行main -> main里面创建异步任务run -> 等待异步任务run（一直等一直等）")])]),s._v(" "),t("p",[s._v("由于主线程没有结束，所以整个python程序一直在等待异步任务执行完毕，毕竟它是死循环，所以会一直等下去。")])]),s._v(" "),t("li",[t("p",[s._v("无await")]),s._v(" "),t("p",[t("strong",[s._v("线程开启 -> 执行main -> main里面创建异步任务run -> 不等待异步任务run -> main方法结束 -> 线程结束 -> 程序退出")])]),s._v(" "),t("p",[t("strong",[s._v("以上都是个人结合go的goroutine给出的理解。肯定会有一些差别的地方。")])])]),s._v(" "),t("li",[t("p",[s._v("再次改造")]),s._v(" "),t("p",[s._v("其实create_task会返回一个task对象，里面有done和cancel方法，也就是说咱们可以取消他也可以完成他。")])])]),s._v(" "),t("div",{staticClass:"language-python line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-python"}},[t("code",[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("import")]),s._v(" asyncio\n\n\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("async")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("def")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("run")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("while")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("True")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("print")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"still alive"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("await")]),s._v(" asyncio"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("sleep"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\n\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("async")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("def")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("main")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    task "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" asyncio"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("create_task"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("run"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("await")]),s._v(" asyncio"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("sleep"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 2秒后，就停掉这个任务")]),s._v("\n    task"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("cancel"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("print")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"task任务结束了，main也即将完成，整个程序即将退出"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\n\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" __name__ "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("==")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"__main__"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    asyncio"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("run"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("main"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br"),t("span",{staticClass:"line-number"},[s._v("18")]),t("br"),t("span",{staticClass:"line-number"},[s._v("19")]),t("br")])]),t("p",[s._v("一旦调用了create_task，那么"),t("code",[s._v("任务就已经开始了")]),s._v("，接着我们用await让main等待2秒，再调用"),t("code",[s._v("task.cancel")]),s._v("方法就可以取消这个task，这样所有事件都结束，程序也会退出了。")]),s._v(" "),t("p",[s._v("看看gif:")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://static.pity.fun/picture/2021-12-11/1639199070799-gif.gif",alt:""}})]),s._v(" "),t("p",[s._v("这时候有的同学可能会问了，await2秒以后，不管你是否调用cancel，因为没有await task，所以程序照样会退出啊，"),t("strong",[s._v("没法证明task真的被cancel了")]),s._v("。")]),s._v(" "),t("p",[s._v("仔细想想，确实说的有道理。那我们再来改造下:")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://static.pity.fun/picture/2021-12-11/1639199294664-image.png",alt:""}})]),s._v(" "),t("p",[s._v("可以看到，这个task死之前还做了"),t("code",[s._v("垂死挣扎")]),s._v("！！！")]),s._v(" "),t("ul",[t("li",[s._v("加上await")])]),s._v(" "),t("p",[t("img",{attrs:{src:"https://static.pity.fun/picture/2021-12-11/1639200201094-gif2.gif",alt:""}})]),s._v(" "),t("p",[s._v("可以看到加上await之后，它还是不会"),t("code",[s._v("停止")]),s._v("。")]),s._v(" "),t("p",[s._v("那我们加上cancel试试:")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://static.pity.fun/picture/2021-12-11/1639200285061-image.png",alt:""}})]),s._v(" "),t("p",[s._v("很遗憾，报错了~~~不过没关系，我们继续改下。只需要加上异常处理，就可以完美实现2秒后"),t("code",[s._v("自动取消任务")]),s._v("了。")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://static.pity.fun/picture/2021-12-11/1639200385271-gif3.gif",alt:""}})]),s._v(" "),t("p",[s._v("但这个例子依然不是很帅，如果只是想"),t("code",[s._v("控制")]),s._v("异步任务的执行时间，那我们可以用wait_for：")]),s._v(" "),t("div",{staticClass:"language-python line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-python"}},[t("code",[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("import")]),s._v(" asyncio\n\n\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("async")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("def")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("run")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("while")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("True")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("print")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"still alive"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("await")]),s._v(" asyncio"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("sleep"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\n\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("async")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("def")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("main")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("try")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("await")]),s._v(" asyncio"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("wait_for"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("run"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("except")]),s._v(" asyncio"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("TimeoutError"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("print")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"run方法超过2秒仍未执行完成"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\n\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" __name__ "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("==")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"__main__"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    asyncio"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("run"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("main"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br"),t("span",{staticClass:"line-number"},[s._v("18")]),t("br")])]),t("p",[s._v("这样2秒后，任务还没结束也不会继续执行了。")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://static.pity.fun/picture/2021-12-11/1639200781192-image.png",alt:""}})]),s._v(" "),t("h2",{attrs:{id:"去掉死循环以后-任务会在2秒内完成-因为只等待1秒-这时候就可以看到timeout异常不会被触发。"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#去掉死循环以后-任务会在2秒内完成-因为只等待1秒-这时候就可以看到timeout异常不会被触发。"}},[s._v("#")]),s._v(" 去掉死循环以后，任务会在2秒内完成（因为只等待1秒），这时候就可以看到"),t("code",[s._v("timeout异常不会被触发")]),s._v("。")]),s._v(" "),t("p",[s._v("emmmm, 今天的内容就介绍到这了，异步还有挺多玩法的，我也不是很清楚，大家可以互相"),t("code",[s._v("交流交流")]),s._v("~~~")])])}),[],!1,null,null,null);t.default=e.exports}}]);