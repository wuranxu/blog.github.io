(window.webpackJsonp=window.webpackJsonp||[]).push([[62],{463:function(t,s,a){"use strict";a.r(s);var r=a(2),p=Object(r.a)({},(function(){var t=this,s=t._self._c;return s("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[s("blockquote",[s("p",[t._v("大家好~我是"),s("code",[t._v("米洛")]),t._v("！"),s("br"),t._v("\n我正在从0到1打造一个开源的接口测试平台, 也在编写一套与之对应的"),s("code",[t._v("教程")]),t._v("，希望大家多多支持。"),s("br"),t._v("\n欢迎关注我的公众号"),s("code",[t._v("米洛的测开日记")]),t._v("，获取最新文章教程!")])]),t._v(" "),s("h3",{attrs:{id:"回顾"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#回顾"}},[t._v("#")]),t._v(" 回顾")]),t._v(" "),s("p",[t._v("上一节我们浅谈了支持grpc的相关思路，只抛出了问题，但没有"),s("code",[t._v("解决问题")]),t._v("，那这一节我们就来聊聊相关的解决方案。")]),t._v(" "),s("h3",{attrs:{id:"核心问题"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#核心问题"}},[t._v("#")]),t._v(" 核心问题")]),t._v(" "),s("p",[t._v("回到之前的核心问题，我们在进行一次grpc的请求时，首先不太明确"),s("code",[t._v("服务部署的地址")]),t._v("，当服务是多节点部署的时候，我们希望能够自动获取到服务的ip和端口。这个问题挺好解决，业内常用的注册中心就那几种，还记得我们之前讲过的"),s("code",[t._v("系统设置")]),t._v("页面吗？")]),t._v(" "),s("p",[s("strong",[t._v("系统设置里面现在可以多加一项，注册中心类型/注册中心地址/服务/方法节点路径，根据配置好的设置针对不同的注册中心，完成我们想要的功能。")])]),t._v(" "),s("p",[t._v("但还有一个stub的问题，这个虽然比较麻烦，但也"),s("code",[t._v("不是没有办法解决")]),t._v("。")]),t._v(" "),s("h3",{attrs:{id:"grpcurl"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#grpcurl"}},[t._v("#")]),t._v(" grpcurl")]),t._v(" "),s("p",[t._v("上一节我们提到过一个关键词: "),s("code",[t._v("grpc_reflection")]),t._v("。没错，这就是我们解决问题的关键。")]),t._v(" "),s("p",[t._v("在介绍反射的时候，我们先来看看一款工具: grpcurl(github一搜就知道)")]),t._v(" "),s("p",[s("img",{attrs:{src:"https://static.pity.fun/picture/2022-2-6/1644136791462-image.png",alt:""}})]),t._v(" "),s("p",[t._v("不难发现，其实它是一款类似于"),s("code",[t._v("CURL")]),t._v("的工具，基于go编写。api也和curl比较接近，但有个问题，它并没有提供python的api。")]),t._v(" "),s("p",[t._v("由于我具备"),s("code",[t._v("go代码")]),t._v("的阅读能力，所以我很好奇它是"),s("code",[t._v("怎么支持无proto调用grpc接口")]),t._v("的，为此我前段时间一直在阅读它的源码。")]),t._v(" "),s("p",[t._v("在阅读他代码的时候，我意外地发现了grpc的一个特质: grpc_reflection，这个简单的说就是grpc反射。（资料也相当少）")]),t._v(" "),s("h4",{attrs:{id:"服务端开启反射"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#服务端开启反射"}},[t._v("#")]),t._v(" 服务端开启反射")]),t._v(" "),s("ol",[s("li",[t._v("安装grpcio-reflection")])]),t._v(" "),s("div",{staticClass:"language-bash line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[t._v("pip "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("install")]),t._v(" grpcio-reflection\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br")])]),s("ol",{attrs:{start:"2"}},[s("li",[t._v("允许服务开启反射")])]),t._v(" "),s("p",[t._v("这边别忘记")]),t._v(" "),s("div",{staticClass:"language-python line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-python"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("from")]),t._v(" grpc_reflection"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("v1alpha "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" reflection\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br")])]),s("p",[s("img",{attrs:{src:"https://static.pity.fun/picture/2022-2-6/1644137091468-image.png",alt:""}})]),t._v(" "),s("p",[t._v("这样启动的时候，服务就开启了反射，我们就可以用grpcurl请求接口了。")]),t._v(" "),s("p",[s("strong",[t._v("简单的说，在grpc服务启动的时候，如果打开了grpc_reflection开关，那么它会自带额外的几个grpc接口，而我们使用的grpcurl也是基于这个原理而工作的。我们来看看它们一一做了些什么")])]),t._v(" "),s("p",[s("img",{attrs:{src:"https://static.pity.fun/picture/2022-2-6/1644137426004-image.png",alt:""}})]),t._v(" "),s("p",[t._v("我们可以看到，反射的服务，主要提供了一个反射服务，里面会有file_by_filename，list_services等方法。其中list_services可以列举出你这个ip+port下的grpc服务有哪些服务，核心的实现方法都在这:")]),t._v(" "),s("p",[s("img",{attrs:{src:"https://static.pity.fun/picture/2022-2-6/1644137582423-image.png",alt:""}})]),t._v(" "),s("p",[s("strong",[t._v("为此本人熬了2天左右，终于完成了一个可以"),s("code",[t._v("摆脱proto")]),t._v("的类似grpcurl的实现，在此感谢grpcurl提供的思路。（对着源码debug）")])]),t._v(" "),s("p",[t._v("最终的实现效果如下:")]),t._v(" "),s("p",[s("img",{attrs:{src:"https://static.pity.fun/picture/2022-2-6/1644137736880-image.png",alt:""}})]),t._v(" "),s("p",[t._v("只需要自己定义一个Stub(因为反射也是个grpc服务，所以我们还是得通过生成反射的stub去获取服务的信息)。")]),t._v(" "),s("p",[t._v("上面的res是获取服务列表并打印，与下面的调用没关系，实际上调用的方法只需要:")]),t._v(" "),s("div",{staticClass:"language-python line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-python"}},[s("code",[t._v("md "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" Stub"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("client"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("channel"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"Hello"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"Edit"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\nparams "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("dict")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("data"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"李逍遥"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\ndata "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" hello_pb2"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("Request"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("**")]),t._v("params"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\nresponse "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" md"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("data"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("print")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("response"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("message"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br"),s("span",{staticClass:"line-number"},[t._v("2")]),s("br"),s("span",{staticClass:"line-number"},[t._v("3")]),s("br"),s("span",{staticClass:"line-number"},[t._v("4")]),s("br"),s("span",{staticClass:"line-number"},[t._v("5")]),s("br"),s("span",{staticClass:"line-number"},[t._v("6")]),s("br")])]),s("p",[t._v("md是通过反射的客户端+服务名+方法名获取到方法，接着直接传入dict即可调用方法。")]),t._v(" "),s("h3",{attrs:{id:"两级反转"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#两级反转"}},[t._v("#")]),t._v(" 两级反转")]),t._v(" "),s("p",[t._v("为啥要做这个库，因为我确实没搜到类似的实现。就当我优化了一些版本，还没支持"),s("code",[t._v("异步")]),t._v("，也没完善各种api的时候，我得意地想把我这个版本传到pypi帮助其他人。")]),t._v(" "),s("p",[t._v("关于命名，我想要它以后和requests一样好用，所以我毫不犹豫叫了grpc-requests，发现一直上传失败。")]),t._v(" "),s("p",[s("strong",[t._v("我在pypi搜索，结果发现一个韩国哥们早就实现了，而且做的还比我屌多了，我比克大魔王当时脸都绿了！！！")])]),t._v(" "),s("p",[s("img",{attrs:{src:"https://static.pity.fun/picture/2022-2-6/1644138042651-image.png",alt:""}})]),t._v(" "),s("p",[t._v("我下载了试用了一番，别人已经碉堡了，而且测下来也没发现啥问题。")]),t._v(" "),s("p",[t._v("所以我肝2天肝了个寂寞，不过把具体的api是"),s("code",[t._v("熟悉")]),t._v("了一遍。所以大家如果有类似需求，直接用这个库就可以了！！！")]),t._v(" "),s("p",[t._v("（"),s("strong",[t._v("我还是咬着牙传了自己的项目到pypi")]),t._v("）")]),t._v(" "),s("p",[s("img",{attrs:{src:"https://static.pity.fun/picture/2022-2-6/1644138162474-image.png",alt:""}})]),t._v(" "),s("h2",{attrs:{id:"这哥们说-如果你的服务开启了反射-你可以自动获取到方法等数据-否则可以继续用stub去调用。我看了这哥们的实现-代码确实写的好过我很多。"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#这哥们说-如果你的服务开启了反射-你可以自动获取到方法等数据-否则可以继续用stub去调用。我看了这哥们的实现-代码确实写的好过我很多。"}},[t._v("#")]),t._v(" 这哥们说，如果你的服务开启了反射，你可以自动获取到方法等数据，否则可以继续用stub去调用。我看了这哥们的实现，代码确实写的好过我很多。")]),t._v(" "),s("p",[t._v("今天的内容就介绍到这里了，关于后续的想法，grpc也是可以根据文件获取到服务信息，唯一我们以后能做的就是根据proto生成接口文档。")]),t._v(" "),s("p",[t._v("（我想这个就算个卖点吧，各位有兴趣也可以自行实现哈！）")])])}),[],!1,null,null,null);s.default=p.exports}}]);